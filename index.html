<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FlightOps Manager - Cloud</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            /* TEMA ESCURO (Dark Mode) */
            --bg-body: #0f172a;
            --bg-card: #1e293b;
            --bg-hover: #334155;
            --bg-modal: #1e293b;
            
            --text-main: #f1f5f9;
            --text-secondary: #94a3b8;
            --border-color: #334155; 

            --primary: #3b82f6;
            --primary-dark: #2563eb;
            --danger: #ef4444;
            --success: #22c55e;

            /* Status Colors */
            --status-aberto-bg: rgba(34, 197, 94, 0.15);
            --status-aberto-text: #4ade80;
            --status-checkin-bg: rgba(249, 115, 22, 0.15);
            --status-checkin-text: #fb923c;
            --status-finalizado-bg: rgba(248, 113, 113, 0.15);
            --status-finalizado-text: #f87171;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-body);
            color: var(--text-main);
            padding: 20px;
            min-height: 100vh;
        }

        .container { max-width: 800px; margin: 0 auto; padding-bottom: 80px; }

        /* --- TELA DE LOGIN --- */
        #login-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--bg-body); z-index: 9999;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
        }
        .login-box {
            background: var(--bg-card); padding: 40px; border-radius: 16px;
            width: 90%; max-width: 400px; border: 1px solid var(--border-color);
            text-align: center;
        }
        .login-logo { font-size: 3rem; margin-bottom: 20px; }
        .hidden { display: none !important; }

        /* --- NAVEGA√á√ÉO E TELAS --- */
        .screen { display: none; animation: fadeIn 0.3s ease; }
        .screen.active { display: block; }
        
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* CABE√áALHOS */
        header {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 20px;
            border-bottom: 1px solid var(--border-color);
            gap: 15px;
        }
        
        .btn-back {
            background: none; border: none; color: var(--text-secondary);
            font-size: 1.5rem; cursor: pointer; padding: 5px;
        }
        .btn-back:hover { color: white; }

        h1 { font-size: 1.5rem; color: var(--text-main); flex: 1; }
        h2 { font-size: 1.2rem; color: white; margin-bottom: 10px; }

        /* --- ABAS (TABS) --- */
        .tab-container {
            display: flex;
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 20px;
        }
        .tab-btn {
            flex: 1;
            background: none;
            border: none;
            padding: 12px;
            color: var(--text-secondary);
            font-weight: 600;
            cursor: pointer;
            border-bottom: 2px solid transparent;
        }
        .tab-btn.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
        }
        .tab-content { display: none; }
        .tab-content.active { display: block; }

        /* --- CARDS DE VOO (DASHBOARD) --- */
        .card {
            background-color: var(--bg-card);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 15px;
            border-left: 4px solid transparent;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
            position: relative;
        }
        .card:active { transform: scale(0.98); }
        
        .card.status-aberto { border-left-color: #4ade80; }
        .card.status-finalizado { border-left-color: #f87171; }
        .card.status-checkin { border-left-color: #fb923c; }

        .card-header { display: flex; justify-content: space-between; align-items: flex-start; }
        .flight-code { font-size: 1.4rem; font-weight: 700; color: #fff; }
        .flight-route { font-size: 0.9rem; color: var(--text-secondary); margin-top: 4px; }

        .badge { padding: 4px 10px; border-radius: 20px; font-size: 0.75rem; font-weight: 700; text-transform: uppercase; }
        .badge.aberto { background: var(--status-aberto-bg); color: var(--status-aberto-text); }
        .badge.finalizado { background: var(--status-finalizado-bg); color: var(--status-finalizado-text); }
        .badge.checkin { background: var(--status-checkin-bg); color: var(--status-checkin-text); }

        .card-actions { margin-top: 15px; padding-top: 15px; border-top: 1px solid var(--border-color); display: flex; gap: 10px; }
        .btn-action { flex: 1; padding: 10px; border: none; background: var(--bg-hover); color: white; border-radius: 8px; font-weight: 600; cursor: pointer; }
        .btn-primary { background: var(--primary); }
        .btn-primary:hover { background: var(--primary-dark); }

        /* --- COMENT√ÅRIOS --- */
        .comment-box {
            background: rgba(255,255,255,0.03);
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 15px;
            border: 1px solid var(--border-color);
        }
        .comment-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 0.8rem;
        }
        .comment-user { color: var(--primary); font-weight: 700; }
        .comment-time { color: var(--text-secondary); }
        .comment-text { color: var(--text-main); font-size: 0.95rem; line-height: 1.5; white-space: pre-wrap; }
        
        .input-group { display: flex; gap: 10px; margin-top: 20px; }

        /* --- LISTAS E CHECKLISTS --- */
        .service-item {
            display: flex; justify-content: space-between; align-items: center;
            background: var(--bg-hover); padding: 15px; border-radius: 12px;
            margin-bottom: 10px; cursor: pointer; border: 1px solid var(--border-color);
        }
        .service-type { font-weight: 800; font-size: 1.2rem; color: var(--primary); margin-right: 10px; }
        .service-pax { color: white; font-weight: 600; }
        .service-seat { color: var(--text-secondary); font-size: 0.9rem; }
        .service-check { font-size: 0.8rem; color: var(--success); }

        .checklist-group { margin-bottom: 30px; }
        .group-title { color: var(--primary); font-size: 1rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 15px; border-bottom: 1px solid var(--border-color); padding-bottom: 8px; }
        .check-item { display: flex; align-items: flex-start; gap: 12px; margin-bottom: 15px; background: rgba(255,255,255,0.03); padding: 12px; border-radius: 8px; }
        
        .custom-checkbox { appearance: none; width: 24px; height: 24px; border: 2px solid var(--text-secondary); border-radius: 6px; cursor: pointer; display: grid; place-content: center; flex-shrink: 0; margin-top: 2px; }
        .custom-checkbox::before { content: ""; width: 12px; height: 12px; transform: scale(0); background-color: white; transform-origin: center; clip-path: polygon(14% 44%, 0 65%, 50% 100%, 100% 16%, 80% 0%, 43% 62%); transition: 120ms transform ease-in-out; }
        .custom-checkbox:checked { background-color: var(--success); border-color: var(--success); }
        .custom-checkbox:checked::before { transform: scale(1); }
        .check-text { font-size: 0.95rem; color: #e2e8f0; line-height: 1.5; }

        /* --- MODAIS E FAB --- */
        .fab { position: fixed; bottom: 20px; right: 20px; width: 60px; height: 60px; border-radius: 50%; background: var(--primary); color: white; font-size: 2rem; border: none; box-shadow: 0 0 15px var(--primary-dark); cursor: pointer; display: grid; place-items: center; z-index: 100; }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); backdrop-filter: blur(5px); z-index: 200; display: none; align-items: center; justify-content: center; }
        .modal-box { background: var(--bg-modal); width: 90%; max-width: 400px; padding: 25px; border-radius: 16px; border: 1px solid var(--border-color); }
        .form-input, .form-select { width: 100%; padding: 12px; background: var(--bg-body); border: 1px solid var(--border-color); color: white; border-radius: 8px; margin-bottom: 15px; font-size: 1rem; }
        
        .info-box { background: rgba(59, 130, 246, 0.1); border: 1px solid var(--primary); padding: 15px; border-radius: 8px; margin-top: 20px; display: none; }
        .info-box.visible { display: block; }
        .info-title { color: var(--primary); font-weight: bold; margin-bottom: 5px; }
        .info-content { font-size: 0.9rem; color: var(--text-secondary); line-height: 1.5; white-space: pre-line; }
        
        #user-info { font-size: 0.8rem; color: var(--text-secondary); margin-left: auto; }
        .logout-link { color: var(--danger); text-decoration: underline; cursor: pointer; margin-left: 10px; }
    </style>
</head>
<body>

    <div id="login-screen">
        <div class="login-box">
            <div class="login-logo">‚úàÔ∏è</div>
            <h2>FlightOps Manager</h2>
            <p style="color:var(--text-secondary); margin-bottom:20px;">Acesso Restrito √† Equipe</p>
            
            <input type="email" id="login-email" class="form-input" placeholder="Seu e-mail corporativo">
            <input type="password" id="login-pass" class="form-input" placeholder="Sua senha">
            
            <button class="btn-action btn-primary" onclick="fazerLogin()">Entrar no Sistema</button>
            <p id="login-msg" style="color:var(--danger); margin-top:10px; font-size:0.9rem;"></p>
        </div>
    </div>

    <div id="app-container" class="container hidden">
        
        <div id="view-dashboard" class="screen active">
            <header>
                <h1>‚úàÔ∏è Opera√ß√µes Solo</h1>
                <div id="user-info">Carregando...</div>
            </header>
            <div id="flight-list">Carregando voos...</div>
        </div>

        <div id="view-flight" class="screen">
            <header>
                <button class="btn-back" onclick="navTo('view-dashboard')">‚Üê</button>
                <div style="flex:1">
                    <h1 id="flight-title" style="margin-bottom:5px;">Voo</h1>
                    <select id="status-selector" class="form-select" style="width: auto; margin-bottom: 0; padding: 6px; font-size: 0.8rem; border-color: var(--border-color);" onchange="alterarStatusVoo(this.value)">
                        <option value="status-aberto">üü¢ ABERTO</option>
                        <option value="status-checkin">üü† CHECKIN FINALIZADO</option>
                        <option value="status-finalizado">üî¥ FINALIZADO</option>
                    </select>
                </div>
            </header>

            <div class="tab-container">
                <button class="tab-btn active" onclick="switchFlightTab('services')">SERVI√áOS</button>
                <button class="tab-btn" onclick="switchFlightTab('comments')">COMENT√ÅRIOS</button>
            </div>

            <div id="tab-services" class="tab-content active">
                <div id="service-list"></div>
                <div style="text-align: center; color: var(--text-secondary); font-size: 0.9rem; margin-top: 40px;" id="empty-msg">Nenhum servi√ßo especial.</div>
            </div>

            <div id="tab-comments" class="tab-content">
                <div id="comments-list" style="margin-bottom: 20px;"></div>
                
                <div class="input-group">
                    <input id="input-comment" class="form-input" style="margin-bottom:0;" placeholder="Digite um coment√°rio ou aviso...">
                    <button class="btn-action btn-primary" style="flex:0 0 60px;" onclick="addComment()">‚û§</button>
                </div>
            </div>
        </div>

        <div id="view-service" class="screen">
            <header>
                <button class="btn-back" onclick="navTo('view-flight')">‚Üê</button>
                <div>
                    <h1 id="service-header-type" style="color:var(--primary)">TYPE</h1>
                    <div id="service-header-detail" style="font-size: 0.9rem; color: white;">Pax</div>
                </div>
            </header>
            <div id="checklist-container"></div> 
            <button class="btn-action" style="width:100%; background: transparent; border: 1px solid var(--primary); color: var(--primary); margin-top: 20px;" onclick="toggleInfo()">‚ÑπÔ∏è Saiba Mais / Regras</button>
            <div id="service-info-box" class="info-box">
                <div class="info-title">Regras e Procedimentos</div>
                <div id="service-rules-content" class="info-content"></div>
            </div>
            <br><br>
            <button class="btn-action" style="width:100%; background: rgba(239,68,68,0.2); color: #f87171;" onclick="deletarServicoAtual()">Remover Servi√ßo</button>
        </div>

        <button id="fab" class="fab" onclick="handleFabClick()">+</button>
        
        <div id="modal-flight" class="modal-overlay">
            <div class="modal-box">
                <h2>Novo Voo</h2>
                <input id="new-flight-code" class="form-input" placeholder="N¬∫ Voo (Ex: LA 3255)">
                <input id="new-flight-route" class="form-input" placeholder="Rota (Ex: GRU-SSA)">
                <div style="display:flex; justify-content: flex-end; gap:10px;">
                    <button class="btn-action" onclick="closeModals()">Cancelar</button>
                    <button class="btn-action btn-primary" onclick="addFlight()">Salvar</button>
                </div>
            </div>
        </div>

        <div id="modal-service" class="modal-overlay">
            <div class="modal-box">
                <h2>Adicionar Servi√ßo</h2>
                <select id="new-service-type" class="form-select">
                    <option value="PETC">PETC (Pet na Cabine)</option>
                    <option value="UMNR">UMNR (Menor Desacompanhado)</option>
                    <option value="AVIH">AVIH (Animal no Por√£o)</option>
                    <option value="MAAS">MAAS (Assist√™ncia)</option>
                </select>
                <input id="new-service-pax" class="form-input" placeholder="Nome do Passageiro">
                <input id="new-service-seat" class="form-input" placeholder="Assento (Ex: 15C)">
                <div style="display:flex; justify-content: flex-end; gap:10px;">
                    <button class="btn-action" onclick="closeModals()">Cancelar</button>
                    <button class="btn-action btn-primary" onclick="addService()">Adicionar</button>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, updateDoc, deleteDoc, doc, onSnapshot, query, orderBy, getDoc } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";

        // SUA CONFIGURA√á√ÉO OFICIAL
        const firebaseConfig = {
            apiKey: "AIzaSyDUDhMZmRNx2msn9SM4Nw5nA3OSRm-hkI0",
            authDomain: "flightops-app.firebaseapp.com",
            projectId: "flightops-app",
            storageBucket: "flightops-app.firebasestorage.app",
            messagingSenderId: "670439671056",
            appId: "1:670439671056:web:5fb610571eaf4d19c9d195",
            measurementId: "G-6082JH911G"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        let currentUserEmail = "";

        // --- LOGIN & WHITELIST ---
        window.fazerLogin = async () => {
            const email = document.getElementById('login-email').value;
            const pass = document.getElementById('login-pass').value;
            const msg = document.getElementById('login-msg');
            
            if(!email || !pass) { msg.innerText = "Preencha tudo."; return; }
            msg.innerText = "Verificando...";

            try {
                const userCredential = await signInWithEmailAndPassword(auth, email, pass);
                const user = userCredential.user;
                const whitelistRef = doc(db, "whitelist", user.email);
                const docSnap = await getDoc(whitelistRef);

                if (docSnap.exists()) {
                    msg.innerText = "";
                } else {
                    throw new Error("Usu√°rio n√£o autorizado pelo administrador.");
                }
            } catch (error) {
                msg.innerText = "Erro: " + error.message;
                signOut(auth);
            }
        };

        window.sair = () => signOut(auth);

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                const whitelistRef = doc(db, "whitelist", user.email);
                const docSnap = await getDoc(whitelistRef);
                
                if(docSnap.exists()) {
                    currentUserEmail = user.email;
                    document.getElementById('login-screen').classList.add('hidden');
                    document.getElementById('app-container').classList.remove('hidden');
                    document.getElementById('user-info').innerHTML = `
                        ${user.email.split('@')[0]} <span class="logout-link" onclick="sair()">(Sair)</span>
                    `;
                    iniciarAppEmTempoReal();
                } else {
                    signOut(auth);
                }
            } else {
                document.getElementById('login-screen').classList.remove('hidden');
                document.getElementById('app-container').classList.add('hidden');
            }
        });


        // --- L√ìGICA DO APP ---
        
        let localFlights = [];
        let currentFlightId = null;
        let currentServiceIndex = null;

        function iniciarAppEmTempoReal() {
            const q = query(collection(db, "voos"), orderBy("createdAt", "desc"));
            
            onSnapshot(q, (snapshot) => {
                localFlights = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
                renderDashboard();
                if(currentFlightId) {
                    const updatedFlight = localFlights.find(f => f.id === currentFlightId);
                    if(updatedFlight) {
                        renderFlightDetails(updatedFlight);
                    }
                }
            });
        }

        // --- RENDERIZA√á√ÉO ---

        const getStatusConfig = (status) => {
            switch(status) {
                case 'status-aberto': return { text: 'Aberto', class: 'aberto' };
                case 'status-checkin': return { text: 'Check-in Finalizado', class: 'checkin' };
                case 'status-finalizado': return { text: 'Finalizado', class: 'finalizado' };
                default: return { text: 'Aberto', class: 'aberto' };
            }
        };

        window.renderDashboard = () => {
            const list = document.getElementById('flight-list');
            list.innerHTML = '';
            
            localFlights.forEach(flight => {
                const config = getStatusConfig(flight.status);
                const card = document.createElement('div');
                card.className = `card ${flight.status}`;
                card.onclick = (e) => { if(!e.target.closest('button')) window.openFlight(flight.id); };
                
                card.innerHTML = `
                    <div class="card-header">
                        <div><div class="flight-code">${flight.code}</div><div class="flight-route">${flight.route}</div></div>
                        <span class="badge ${config.class}">${config.text}</span>
                    </div>
                    <div class="card-actions">
                        <button class="btn-action" style="background:transparent; color:#ef4444; flex:0;" onclick="deleteFlight('${flight.id}')">üóëÔ∏è</button>
                        <button class="btn-action btn-primary" onclick="openFlight('${flight.id}')">Detalhes</button>
                    </div>
                `;
                list.appendChild(card);
            });
        };

        window.navTo = (screenId) => {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(screenId).classList.add('active');
            const fab = document.getElementById('fab');
            fab.style.display = screenId === 'view-service' ? 'none' : 'grid';
        };

        window.switchFlightTab = (tabName) => {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            
            // Ativar aba clicada
            const btnIndex = tabName === 'services' ? 0 : 1;
            document.querySelectorAll('.tab-btn')[btnIndex].classList.add('active');
            document.getElementById(`tab-${tabName}`).classList.add('active');
            
            // Controlar FAB
            const fab = document.getElementById('fab');
            if (tabName === 'comments') fab.style.display = 'none';
            else fab.style.display = 'grid';
        };

        window.openFlight = (id) => {
            currentFlightId = id;
            const flight = localFlights.find(f => f.id === id);
            if(!flight) return;

            // Resetar para a aba de servi√ßos ao abrir
            window.switchFlightTab('services');
            
            renderFlightDetails(flight);
            navTo('view-flight');
        };

        window.renderFlightDetails = (flight) => {
            document.getElementById('flight-title').innerText = flight.code;
            document.getElementById('status-selector').value = flight.status;
            
            // Render Servi√ßos
            const list = document.getElementById('service-list');
            const emptyMsg = document.getElementById('empty-msg');
            list.innerHTML = '';
            const services = flight.services || [];

            if (services.length === 0) {
                emptyMsg.style.display = 'block';
            } else {
                emptyMsg.style.display = 'none';
                services.forEach((service, index) => {
                    const checkedCount = Object.values(service.checks || {}).filter(Boolean).length;
                    const div = document.createElement('div');
                    div.className = 'service-item';
                    div.onclick = () => window.openService(index);
                    div.innerHTML = `
                        <div style="display:flex; align-items:center;">
                            <span class="service-type">${service.type}</span>
                            <div><div class="service-pax">${service.paxName}</div><div class="service-seat">Assento ${service.seat}</div></div>
                        </div>
                        <div class="service-check">${checkedCount} ok</div>
                    `;
                    list.appendChild(div);
                });
            }

            // Render Coment√°rios
            const commentsList = document.getElementById('comments-list');
            commentsList.innerHTML = '';
            const comments = flight.comments || [];
            
            if(comments.length === 0) {
                commentsList.innerHTML = '<p style="text-align:center; color:var(--text-secondary); margin-top:20px;">Nenhum coment√°rio.</p>';
            } else {
                comments.forEach(c => {
                    const date = new Date(c.timestamp);
                    const timeStr = `${date.getDate()}/${date.getMonth()+1} ${date.getHours()}:${date.getMinutes().toString().padStart(2,'0')}`;
                    const div = document.createElement('div');
                    div.className = 'comment-box';
                    div.innerHTML = `
                        <div class="comment-header">
                            <span class="comment-user">${c.user.split('@')[0]}</span>
                            <span class="comment-time">${timeStr}</span>
                        </div>
                        <div class="comment-text">${c.text}</div>
                    `;
                    commentsList.appendChild(div);
                });
            }
        };

        window.addComment = async () => {
            const input = document.getElementById('input-comment');
            const text = input.value.trim();
            if(!text) return;

            const flightRef = doc(db, "voos", currentFlightId);
            const flight = localFlights.find(f => f.id === currentFlightId);
            const currentComments = flight.comments || [];

            const newComment = {
                text: text,
                user: currentUserEmail,
                timestamp: Date.now()
            };

            await updateDoc(flightRef, { comments: [...currentComments, newComment] });
            input.value = '';
        };

        // --- CHECKLISTS TEMPLATES (Mantidos iguais) ---
        const SERVICE_TEMPLATES = {
            "PETC": {
                name: "Pet na Cabine",
                rules: "‚Ä¢ Esp√©cie: C√£o ou Gato (>16 semanas).\n‚Ä¢ Proibido: Menor Desacompanhado, Fileira 1, Sa√≠da de Emerg√™ncia.\n‚Ä¢ Kennel R√≠gido: 36x33x19cm | Flex√≠vel: 40x28x25cm.\n‚Ä¢ Animal deve ficar totalmente dentro do kennel durante todo o voo.",
                groups: [
                    {
                        title: "1. Triagem Inicial e Elegibilidade",
                        items: [
                            "<strong>Esp√©cie e Idade:</strong> Confirmar se √© apenas c√£o ou gato com, no m√≠nimo, 16 semanas de vida.",
                            "<strong>Restri√ß√£o de Passageiro:</strong> Garantir que o passageiro n√£o √© um Menor Desacompanhado (UMNR).",
                            "<strong>Compatibilidade:</strong> Verificar se o passageiro n√£o possui ber√ßo (BSCT), oxig√™nio (PPOC), c√£o de servi√ßo (SVAN) ou suporte emocional (ESAN), pois estes s√£o incompat√≠veis.",
                            "<strong>Limite por Cabine:</strong> Validar se n√£o excede o m√°ximo de 6 animais por voo (1 na Premium Economy e 5 na Economy)."
                        ]
                    },
                    {
                        title: "2. Documenta√ß√£o e Requisitos",
                        items: [
                            "<strong>Certificado Veterin√°rio:</strong> Validar documento original e c√≥pia, emitido h√° no m√°ximo 10 dias antes do voo (nome, idade, ra√ßa, vacinas).",
                            "<strong>Vacina Antirr√°bica (Brasil):</strong> V√°lida. Se for a primeira dose, deve ter sido aplicada h√° pelo menos 21 dias.",
                            "<strong>TIMATIC:</strong> Consultar requisitos espec√≠ficos do destino/conex√£o (ex: CDC para EUA, Aruba, Noronha)."
                        ]
                    },
                    {
                        title: "3. Inspe√ß√£o do Kennel",
                        items: [
                            "<strong>Dimens√µes M√°ximas:</strong><br>‚Ä¢ R√≠gido: 36x33x19 cm<br>‚Ä¢ Flex√≠vel: 40x28x25 cm",
                            "<strong>Conforto Animal:</strong> Confirmar que o animal consegue ficar em p√© e se mover naturalmente sem tocar no teto/paredes.",
                            "<strong>Seguran√ßa e Higiene:</strong> O kennel deve ter base imperme√°vel, ventila√ß√£o e trava que impe√ßa a sa√≠da.",
                            "<strong>Proibi√ß√£o de Rodas:</strong> Negar embarque se o kennel possuir rodas."
                        ]
                    },
                    {
                        title: "4. Procedimentos e Taxas",
                        items: [
                            "<strong>SSR PETC:</strong> Inserir/verificar dados no sistema: tipo, peso (animal+kennel), ra√ßa, idade, tipo kennel e medidas.",
                            "<strong>Check-list IATA:</strong> Preencher obrigatoriamente o Check-list PETC (digital ou impresso).",
                            "<strong>Pagamento:</strong> Confirmar se a taxa foi paga (EMD, CUV ou MSR) ou encaminhar para a loja.",
                            "<strong>Aloca√ß√£o de Assento:</strong><br>‚Ä¢ <span style='color:#ef4444'>Proibido:</span> 1¬™ fileira e sa√≠das de emerg√™ncia.<br>‚Ä¢ <span style='color:#4ade80'>Recomendado:</span> C, D, J ou H (para encaixe sob assento)."
                        ]
                    },
                    {
                        title: "5. Instru√ß√µes Finais",
                        items: [
                            "<strong>Cust√≥dia a Bordo:</strong> Informar que o animal deve permanecer totalmente dentro do kennel fechado do embarque ao desembarque.",
                            "<strong>Proibi√ß√£o de Alimenta√ß√£o:</strong> Notificar que o animal n√£o pode ser alimentado a bordo.",
                            "<strong>Briefing de Embarque:</strong> Informar ao Chefe de Cabine sobre a presen√ßa do animal."
                        ]
                    }
                ]
            },
            
            "UMNR": {
                name: "Menor Desacompanhado",
                rules: "‚Ä¢ Idade: 8 a 11 (Obrigat√≥rio) | 12 a 17 (Opcional).\n‚Ä¢ Voo: Direto para <11 anos. Conex√£o s√≥ 12-17 em voos <4h.\n‚Ä¢ Proibido: Viajar com PETC/AVIH.\n‚Ä¢ Assento: Corredor. (Economy: Pen√∫ltima/Antepen√∫ltima fileira).",
                groups: [
                    {
                        title: "1. Pr√©-atendimento & Elegibilidade",
                        items: [
                            "<strong>Verificar Idade:</strong> Obrigat√≥rio (8 a 11 anos); Opcional (12 a 17 anos).",
                            "<strong>Status da Reserva:</strong> Confirmar se o servi√ßo est√° com status HK ou KK e se foi solicitado com 48h de anteced√™ncia.",
                            "<strong>Autonomia do Menor:</strong> Confirmar se compreende seguran√ßa, locomove-se sozinho e atende necessidades b√°sicas.",
                            "<strong>Restri√ß√µes de Itiner√°rio:</strong> Validar se voo √© direto para < 11 anos (conex√µes apenas 12-17 anos em voos < 4h).",
                            "<strong>Proibi√ß√µes:</strong> Garantir que n√£o viaja com animais (PETC/AVIH) ou necessita de medicamentos administrados."
                        ]
                    },
                    {
                        title: "2. Check-in & Documenta√ß√£o",
                        items: [
                            "<strong>Presen√ßa do Respons√°vel:</strong> O menor deve estar obrigatoriamente com um adulto.",
                            "<strong>Documenta√ß√£o:</strong> Conferir RG, Certid√£o de Nascimento ou Passaporte.",
                            "<strong>Autoriza√ß√£o de Viagem:</strong> Judicial, consular ou cart√≥rio. Se AEV, validar QR Code no app.",
                            "<strong>Formul√°rio UMNR:</strong> Preencher todas as vias (Original: Pai | C√≥pias: Origem, Chefe Cabine, Destino).",
                            "<strong>Pagamento:</strong> Verificar se a taxa foi paga ou encaminhar √† loja.",
                            "<strong>Etiquetagem:</strong> Colocar etiquetas 'Menor Desacompanhado' na bagagem de m√£o e despachada.",
                            "<strong>Protocolo Verbal:</strong> Informar ao respons√°vel que deve permanecer at√© a decolagem."
                        ]
                    },
                    {
                        title: "3. Cust√≥dia & Embarque",
                        items: [
                            "<strong>Child Tracker:</strong> Colocar pulseira e ler c√≥digo 2D no app (se aplic√°vel).",
                            "<strong>Envelope UM:</strong> Guardar todos os documentos e via do formul√°rio no envelope.",
                            "<strong>Acompanhamento:</strong> Agente assume o menor (max 3 menores por agente).",
                            "<strong>Prioridade:</strong> Embarcar o menor antes dos demais.",
                            "<strong>Assento Correto:</strong><br>‚Ä¢ Economy: Corredor na pen√∫ltima ou antepen√∫ltima (proibido emerg√™ncia).<br>‚Ä¢ Business: Corredor, preferencialmente 3 primeiras."
                        ]
                    }
                ]
            },

            "AVIH": {
                name: "Animal no Por√£o",
                rules: "‚Ä¢ Restri√ß√£o Calor (BR): 10h01 √†s 15h59.\n‚Ä¢ Kennel: R√≠gido, porta met√°lica trava dupla, sem rodas.\n‚Ä¢ Obrigat√≥rio: 2 potes na porta, lacres, 5cm folga teto.\n‚Ä¢ Documentos: 2 c√≥pias atestado (<10 dias).",
                groups: [
                    {
                        title: "1. Triagem Inicial e Elegibilidade",
                        items: [
                            "<strong>Reserva Confirmada:</strong> Verificar status HK/KK (min 48h anteced√™ncia).",
                            "<strong>Esp√©cie e Idade:</strong> C√£o ou gato, min 16 semanas.",
                            "<strong>Ra√ßas Proibidas:</strong> N√£o pode ser braquicef√°lico ou perigoso.",
                            "<strong>Restri√ß√µes Clim√°ticas:</strong><br>‚Ä¢ Brasil: Restrito 10h01-15h59 (Calor).<br>‚Ä¢ Intl: Verificar embargos (ex: JFK/BOS Inverno).",
                            "<strong>UMNR:</strong> Passageiro N√ÉO pode ser menor desacompanhado."
                        ]
                    },
                    {
                        title: "2. Documenta√ß√£o e Requisitos",
                        items: [
                            "<strong>Certificado Veterin√°rio:</strong> 2 c√≥pias (1 para arquivo), emitido <10 dias.",
                            "<strong>Vacina Antirr√°bica:</strong> V√°lida (>21 dias se 1¬™ dose).",
                            "<strong>TIMATIC:</strong> Consultar regras do destino (ex: CDC EUA)."
                        ]
                    },
                    {
                        title: "3. Inspe√ß√£o do Kennel",
                        items: [
                            "<strong>Material:</strong> Pl√°stico duro/fibra, porta met√°lica com trava dupla.",
                            "<strong>Caracter√≠sticas:</strong> Teto s√≥lido, base imperme√°vel, al√ßas.",
                            "<strong>Rodas:</strong> Proibido (devem ser removidas).",
                            "<strong>Acess√≥rios:</strong> 2 recipientes fixados √† porta (acesso externo).",
                            "<strong>Itens Proibidos:</strong> Sem coleiras, roupas ou brinquedos dentro."
                        ]
                    },
                    {
                        title: "4. Conforto e Seguran√ßa",
                        items: [
                            "<strong>Espa√ßo Interno:</strong> Animal fica em p√©, gira e deita naturalmente.",
                            "<strong>Folga do Teto:</strong> Min 5cm entre cabe√ßa/orelhas e o teto.",
                            "<strong>Lacres:</strong> Instalar 2 a 6 lacres na porta."
                        ]
                    },
                    {
                        title: "5. Sistema e Identifica√ß√£o",
                        items: [
                            "<strong>Pesagem:</strong> Total (Animal+Kennel) < 32kg ou 45kg.",
                            "<strong>Registro:</strong> Inserir peso e qtd exatos no sistema.",
                            "<strong>Etiquetas:</strong> 'Live Animal' preenchida + Setas 'This Way Up'.",
                            "<strong>Pet Tracker (BR):</strong> Pulseira branca no kennel + Check-in App Siga Mobile."
                        ]
                    },
                    {
                        title: "6. Finaliza√ß√£o e Rampa",
                        items: [
                            "<strong>NOTOC:</strong> Preparar notifica√ß√£o ao comandante.",
                            "<strong>Documenta√ß√£o:</strong> Anexar envelope (NOTOC + Originais) ao kennel.",
                            "<strong>Handover:</strong> Entregar √† rampa para transporte seguro."
                        ]
                    }
                ]
            },

            "MAAS": {
                name: "Assist√™ncia Especial (MAAS)",
                rules: "‚Ä¢ P√∫blico: Idosos (‚â•60), Gestantes, M√£e+Beb√™, Autonomia Limitada.\n‚Ä¢ Assentos gratuitos (Seat Selection/Atributos).\n‚Ä¢ N√ÉO √© cust√≥dia integral (√© apenas facilita√ß√£o).\n‚Ä¢ N√£o requer reserva pr√©via.",
                groups: [
                    {
                        title: "1. Triagem e Elegibilidade",
                        items: [
                            "<strong>Verificar P√∫blico-alvo:</strong> Idoso (‚â• 60 anos), gestante, m√£e com beb√™ de colo ou autonomia limitada (ex: muletas).",
                            "<strong>Sele√ß√£o de Assento:</strong> Garantir acesso gratuito aos produtos Seat Selection e Assentos com Atributos.",
                            "<strong>Esclarecimento sobre Cust√≥dia:</strong> Informar que a assist√™ncia facilita os processos, mas n√£o √© cust√≥dia integral."
                        ]
                    },
                    {
                        title: "2. Processo de Check-in",
                        items: [
                            "<strong>Ativa√ß√£o no Sistema:</strong> Identificar c√≥digo MAAS na reserva ou inserir manualmente (n√£o requer reserva pr√©via).",
                            "<strong>Etiquetagem:</strong> Identificar obrigatoriamente a bagagem com a etiqueta PNAE / Assist√™ncia Especial.",
                            "<strong>Acompanhamento Inicial:</strong> Conduzir desde o balc√£o, passando obrigatoriamente pelo Raio-X e fronteira."
                        ]
                    },
                    {
                        title: "3. Embarque e Perman√™ncia",
                        items: [
                            "<strong>Acesso Priorit√°rio:</strong> Encaminhar o passageiro atrav√©s do acesso 'Prioridade por Lei'.",
                            "<strong>Condu√ß√£o √† Aeronave:</strong> Acompanhar o passageiro at√© a porta da aeronave."
                        ]
                    }
                ]
            }
        };

        window.openService = (index) => {
            currentServiceIndex = index;
            const flight = localFlights.find(f => f.id === currentFlightId);
            const service = flight.services[index];
            const template = SERVICE_TEMPLATES[service.type];

            document.getElementById('service-header-type').innerText = template.name;
            document.getElementById('service-header-detail').innerText = `${service.paxName} ‚Ä¢ ${service.seat}`;
            document.getElementById('service-rules-content').innerText = template.rules;
            document.getElementById('service-info-box').classList.remove('visible');

            const container = document.getElementById('checklist-container');
            container.innerHTML = '';

            let globalIdx = 0;
            template.groups.forEach(group => {
                let html = `<div class="checklist-group"><div class="group-title">${group.title}</div>`;
                group.items.forEach(itemText => {
                    const isChecked = service.checks && service.checks[globalIdx] ? 'checked' : '';
                    html += `
                        <label class="check-item">
                            <input type="checkbox" class="custom-checkbox" ${isChecked} onchange="updateCheck(${globalIdx}, this.checked)">
                            <div class="check-text">${itemText}</div>
                        </label>`;
                    globalIdx++;
                });
                html += `</div>`;
                container.innerHTML += html;
            });
            navTo('view-service');
        };

        // --- A√á√ïES DE BANCO DE DADOS (WRITE) ---

        window.alterarStatusVoo = async (novoStatus) => {
            if(!currentFlightId) return;
            const flightRef = doc(db, "voos", currentFlightId);
            await updateDoc(flightRef, { status: novoStatus });
        };

        window.addFlight = async () => {
            const code = document.getElementById('new-flight-code').value;
            const route = document.getElementById('new-flight-route').value;
            if(!code) return;

            // Salva no Firestore
            await addDoc(collection(db, "voos"), {
                code, route, status: "status-aberto", services: [], comments: [], createdAt: Date.now()
            });
            
            closeModals();
            document.getElementById('new-flight-code').value = '';
            document.getElementById('new-flight-route').value = '';
        };

        window.deleteFlight = async (id) => {
            if(confirm("Apagar voo?")) {
                await deleteDoc(doc(db, "voos", id));
            }
        };

        window.addService = async () => {
            const type = document.getElementById('new-service-type').value;
            const pax = document.getElementById('new-service-pax').value;
            const seat = document.getElementById('new-service-seat').value;
            if(!pax) return;

            const flightRef = doc(db, "voos", currentFlightId);
            const flight = localFlights.find(f => f.id === currentFlightId);
            const newServices = [...flight.services, { type, paxName: pax, seat: seat || "S/A", checks: {} }];

            await updateDoc(flightRef, { services: newServices });
            
            closeModals();
            document.getElementById('new-service-pax').value = '';
        };

        window.updateCheck = async (idx, checked) => {
            const flightRef = doc(db, "voos", currentFlightId);
            const flight = localFlights.find(f => f.id === currentFlightId);
            const services = [...flight.services];
            
            if(!services[currentServiceIndex].checks) services[currentServiceIndex].checks = {};
            services[currentServiceIndex].checks[idx] = checked;

            await updateDoc(flightRef, { services: services });
        };

        window.deletarServicoAtual = async () => {
            if(confirm("Remover servi√ßo?")) {
                const flightRef = doc(db, "voos", currentFlightId);
                const flight = localFlights.find(f => f.id === currentFlightId);
                const services = [...flight.services];
                services.splice(currentServiceIndex, 1);

                await updateDoc(flightRef, { services: services });
                navTo('view-flight');
            }
        };

        window.handleFabClick = () => {
            if(document.getElementById('view-dashboard').classList.contains('active')) {
                document.getElementById('modal-flight').style.display = 'flex';
            } else {
                document.getElementById('modal-service').style.display = 'flex';
            }
        };
        window.closeModals = () => document.querySelectorAll('.modal-overlay').forEach(m => m.style.display = 'none');
        window.toggleInfo = () => document.getElementById('service-info-box').classList.toggle('visible');

    </script>
</body>
</html>