<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FlightOps Manager - Cloud</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            /* TEMA ESCURO (Dark Mode) */
            --bg-body: #0f172a;
            --bg-card: #1e293b;
            --bg-hover: #334155;
            --bg-modal: #1e293b;
            
            --text-main: #f1f5f9;
            --text-secondary: #94a3b8;
            --border-color: #334155; 

            --primary: #3b82f6;
            --primary-dark: #2563eb;
            --danger: #ef4444;
            --success: #22c55e;
            --warning: #f59e0b;
            --sig-color: #d946ef; /* Cor Magente para SIG */

            /* Status Colors */
            --status-aberto-bg: rgba(34, 197, 94, 0.15);
            --status-aberto-text: #4ade80;
            --status-checkin-bg: rgba(249, 115, 22, 0.15);
            --status-checkin-text: #fb923c;
            --status-finalizado-bg: rgba(248, 113, 113, 0.15);
            --status-finalizado-text: #f87171;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-body);
            color: var(--text-main);
            padding: 20px;
            min-height: 100vh;
        }

        .container { max-width: 1100px; margin: 0 auto; padding-bottom: 80px; }

        /* --- TELA DE LOGIN --- */
        #login-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--bg-body); z-index: 9999;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
        }
        .login-box {
            background: var(--bg-card); padding: 40px; border-radius: 16px;
            width: 90%; max-width: 400px; border: 1px solid var(--border-color);
            text-align: center;
        }
        .login-logo { font-size: 3rem; margin-bottom: 20px; }
        .hidden { display: none !important; }

        /* --- NAVEGA√á√ÉO E TELAS --- */
        .screen { display: none; animation: fadeIn 0.3s ease; }
        .screen.active { display: block; }
        
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* CABE√áALHOS */
        header {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 20px;
            border-bottom: 1px solid var(--border-color);
            gap: 15px;
        }
        
        .btn-back {
            background: none; border: none; color: var(--text-secondary);
            font-size: 1.5rem; cursor: pointer; padding: 5px;
        }
        .btn-back:hover { color: white; }

        h1 { font-size: 1.5rem; color: var(--text-main); flex: 1; }
        h2 { font-size: 1.2rem; color: white; margin-bottom: 10px; }

        /* --- LAYOUTS DE GRID (VOO E SERVI√áO) --- */
        .flight-layout { display: grid; gap: 20px; alignItems: start; grid-template-columns: 280px 1fr; }
        .service-layout { display: grid; gap: 20px; alignItems: start; grid-template-columns: 1fr 300px; }

        /* Painel de Tarefas (Voo) */
        .task-panel {
            background: rgba(30, 41, 59, 0.5); border: 1px solid var(--border-color);
            border-radius: 12px; padding: 15px; height: fit-content; position: sticky; top: 20px;
        }
        
        /* Painel Lateral de Servi√ßo (Status) */
        .service-sidebar { display: flex; flex-direction: column; gap: 15px; position: sticky; top: 20px; }
        .status-card { background: var(--bg-card); border: 1px solid var(--border-color); border-radius: 12px; padding: 20px; }
        .status-btn-group { display: flex; flex-direction: column; gap: 10px; margin-top: 10px; }

        .btn-status {
            padding: 15px; border-radius: 8px; border: 2px solid var(--border-color);
            background: var(--bg-body); color: var(--text-secondary); font-weight: 600;
            cursor: pointer; transition: all 0.2s; display: flex; align-items: center; justify-content: center; gap: 8px;
        }
        .btn-status:hover { background: var(--bg-hover); }
        .btn-status.active-standby { background: rgba(245, 158, 11, 0.15); border-color: var(--warning); color: var(--warning); }
        .btn-status.active-lounge { background: rgba(34, 197, 94, 0.15); border-color: var(--success); color: var(--success); }
        .btn-status.active-delivered { background: rgba(34, 197, 94, 0.15); border-color: var(--success); color: var(--success); }
        
        /* TAREFAS ESTILOS */
        .task-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; font-size: 0.9rem; font-weight: 700; color: var(--text-secondary); text-transform: uppercase; }
        .task-list { display: flex; flex-direction: column; gap: 10px; }
        .task-item { background: var(--bg-card); border: 1px solid var(--border-color); border-radius: 8px; padding: 12px; position: relative; transition: all 0.2s; }
        .task-item.priority-high { border-left: 4px solid var(--danger); background: rgba(239, 68, 68, 0.05); }
        .task-item.priority-normal { border-left: 4px solid var(--text-secondary); }
        .task-item.done { opacity: 0.5; text-decoration: line-through; }
        .task-top { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 5px; }
        .task-tag { font-size: 0.65rem; padding: 2px 6px; border-radius: 4px; font-weight: bold; text-transform: uppercase; }
        .tag-urgent { background: var(--danger); color: white; }
        .tag-routine { background: var(--bg-hover); color: var(--text-secondary); }
        .task-check { width: 20px; height: 20px; cursor: pointer; border-radius: 50%; border: 2px solid var(--text-secondary); display: grid; place-items: center; flex-shrink: 0; }
        .task-check.checked { background: var(--success); border-color: var(--success); }
        .task-check.checked::after { content: "‚úì"; color: white; font-size: 0.8rem; }

        /* --- ABAS (TABS) --- */
        .tab-container { display: flex; border-bottom: 1px solid var(--border-color); margin-bottom: 20px; }
        .tab-btn { flex: 1; background: none; border: none; padding: 12px; color: var(--text-secondary); font-weight: 600; cursor: pointer; border-bottom: 2px solid transparent; }
        .tab-btn.active { color: var(--primary); border-bottom-color: var(--primary); }
        .tab-content { display: none; }
        .tab-content.active { display: block; }

        /* --- CARDS DE VOO (DASHBOARD) --- */
        .card { background-color: var(--bg-card); border-radius: 16px; padding: 20px; margin-bottom: 15px; border-left: 4px solid transparent; box-shadow: 0 4px 6px rgba(0,0,0,0.3); position: relative; }
        .card:active { transform: scale(0.98); }
        .card.status-aberto { border-left-color: #4ade80; }
        .card.status-finalizado { border-left-color: #f87171; }
        .card.status-checkin { border-left-color: #fb923c; }
        .card-header { display: flex; justify-content: space-between; align-items: flex-start; }
        .flight-code { font-size: 1.4rem; font-weight: 700; color: #fff; }
        .flight-route { font-size: 0.9rem; color: var(--text-secondary); margin-top: 4px; }
        .badge { padding: 4px 10px; border-radius: 20px; font-size: 0.75rem; font-weight: 700; text-transform: uppercase; }
        .badge.aberto { background: var(--status-aberto-bg); color: var(--status-aberto-text); }
        .badge.finalizado { background: var(--status-finalizado-bg); color: var(--status-finalizado-text); }
        .badge.checkin { background: var(--status-checkin-bg); color: var(--status-checkin-text); }
        .card-actions { margin-top: 15px; padding-top: 15px; border-top: 1px solid var(--border-color); display: flex; gap: 10px; }
        .btn-action { flex: 1; padding: 10px; border: none; background: var(--bg-hover); color: white; border-radius: 8px; font-weight: 600; cursor: pointer; }
        .btn-primary { background: var(--primary); }
        .btn-primary:hover { background: var(--primary-dark); }
        .btn-role { background: var(--bg-card); border: 2px solid var(--border-color); margin-bottom: 10px; text-align: left; padding: 15px; transition: 0.2s; }
        .btn-role:hover { border-color: var(--primary); background: var(--bg-hover); }
        .btn-sm { padding: 4px 8px; font-size: 0.8rem; border-radius: 4px; }

        /* --- ESTILOS DESEMBARQUE (ARRIVAL) --- */
        .arrival-header-card {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(30, 41, 59, 0.5));
            border: 1px solid var(--primary);
            padding: 20px; border-radius: 12px; margin-bottom: 20px;
            text-align: center;
        }
        .arrival-create-btn { width: 100%; padding: 30px; border: 2px dashed var(--border-color); background: rgba(255,255,255,0.02); color: var(--text-secondary); cursor: pointer; border-radius: 12px; font-size: 1.1rem; }
        .arrival-create-btn:hover { border-color: var(--primary); color: var(--primary); background: rgba(59, 130, 246, 0.05); }

        .arrival-item {
            background: var(--bg-card); border: 1px solid var(--border-color); border-radius: 8px;
            padding: 15px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center;
        }
        .arrival-item.is-sig { border-left: 4px solid var(--sig-color); background: rgba(217, 70, 239, 0.05); }
        .sig-badge { background: var(--sig-color); color: white; padding: 2px 6px; border-radius: 4px; font-size: 0.7rem; font-weight: bold; margin-left: 8px; }

        /* --- COMENT√ÅRIOS E ALERTAS --- */
        .comment-box { background: rgba(255,255,255,0.03); padding: 15px; border-radius: 12px; margin-bottom: 15px; border: 1px solid var(--border-color); position: relative; }
        .comment-box.urgent { background: rgba(239, 68, 68, 0.15); border: 1px solid var(--danger); animation: pulse 2s infinite; }
        .comment-header { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 0.8rem; }
        .comment-user { color: var(--primary); font-weight: 700; }
        .urgent .comment-user { color: #fca5a5; }
        .comment-role-badge { font-size: 0.7rem; padding: 2px 6px; border-radius: 4px; margin-left: 8px; background: var(--bg-body); border: 1px solid var(--border-color); }
        .urgent .comment-role-badge { background: var(--danger); border: none; color: white; }
        .comment-time { color: var(--text-secondary); }
        .comment-text { color: var(--text-main); font-size: 0.95rem; line-height: 1.5; white-space: pre-wrap; }
        .input-group { display: flex; gap: 10px; margin-top: 20px; }

        /* --- POPUP DE ALERTA --- */
        #alert-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 99999; display: none; justify-content: center; align-items: center; backdrop-filter: blur(8px); }
        .alert-box { background: #1e293b; border: 2px solid var(--danger); width: 90%; max-width: 450px; padding: 30px; border-radius: 20px; text-align: center; box-shadow: 0 0 50px rgba(239, 68, 68, 0.4); animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both; }
        .alert-icon { font-size: 3rem; margin-bottom: 15px; }
        .alert-title { color: var(--danger); font-size: 1.5rem; font-weight: 800; text-transform: uppercase; margin-bottom: 15px; }
        .alert-message { font-size: 1.1rem; color: white; line-height: 1.6; margin-bottom: 25px; background: rgba(0,0,0,0.3); padding: 15px; border-radius: 8px; }
        .alert-author { font-size: 0.9rem; color: #94a3b8; margin-bottom: 20px; }

        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.4); } 70% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); } 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); } }
        @keyframes shake { 10%, 90% { transform: translate3d(-1px, 0, 0); } 20%, 80% { transform: translate3d(2px, 0, 0); } 30%, 50%, 70% { transform: translate3d(-4px, 0, 0); } 40%, 60% { transform: translate3d(4px, 0, 0); } }

        /* --- LISTAS E CHECKLISTS --- */
        .service-item { display: flex; justify-content: space-between; align-items: center; background: var(--bg-hover); padding: 15px; border-radius: 12px; margin-bottom: 10px; cursor: pointer; border: 1px solid var(--border-color); }
        .service-type { font-weight: 800; font-size: 1.2rem; color: var(--primary); margin-right: 10px; }
        .service-pax { color: white; font-weight: 600; }
        .service-seat { color: var(--text-secondary); font-size: 0.9rem; }
        .service-check { font-size: 0.8rem; color: var(--success); }
        .service-status-pill { font-size: 0.7rem; padding: 2px 6px; border-radius: 4px; margin-left: 8px; text-transform: uppercase; font-weight: bold; }

        .checklist-group { margin-bottom: 30px; }
        .group-title { color: var(--primary); font-size: 1rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 15px; border-bottom: 1px solid var(--border-color); padding-bottom: 8px; }
        .check-item { display: flex; align-items: flex-start; gap: 12px; margin-bottom: 15px; background: rgba(255,255,255,0.03); padding: 12px; border-radius: 8px; }
        
        .custom-checkbox { appearance: none; width: 24px; height: 24px; border: 2px solid var(--text-secondary); border-radius: 6px; cursor: pointer; display: grid; place-content: center; flex-shrink: 0; margin-top: 2px; }
        .custom-checkbox::before { content: ""; width: 12px; height: 12px; transform: scale(0); background-color: white; transform-origin: center; clip-path: polygon(14% 44%, 0 65%, 50% 100%, 100% 16%, 80% 0%, 43% 62%); transition: 120ms transform ease-in-out; }
        .custom-checkbox:checked { background-color: var(--success); border-color: var(--success); }
        .custom-checkbox:checked::before { transform: scale(1); }
        .check-text { font-size: 0.95rem; color: #e2e8f0; line-height: 1.5; }

        /* --- MODAIS E FAB --- */
        .fab { position: fixed; bottom: 20px; right: 20px; width: 60px; height: 60px; border-radius: 50%; background: var(--primary); color: white; font-size: 2rem; border: none; box-shadow: 0 0 15px var(--primary-dark); cursor: pointer; display: grid; place-items: center; z-index: 100; }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); backdrop-filter: blur(5px); z-index: 200; display: none; align-items: center; justify-content: center; }
        .modal-box { background: var(--bg-modal); width: 90%; max-width: 400px; padding: 25px; border-radius: 16px; border: 1px solid var(--border-color); }
        .form-input, .form-select { width: 100%; padding: 12px; background: var(--bg-body); border: 1px solid var(--border-color); color: white; border-radius: 8px; margin-bottom: 15px; font-size: 1rem; }
        
        .info-box { background: rgba(59, 130, 246, 0.1); border: 1px solid var(--primary); padding: 15px; border-radius: 8px; margin-top: 10px; display: none; }
        .info-box.visible { display: block; }
        .info-title { color: var(--primary); font-weight: bold; margin-bottom: 5px; }
        .info-content { font-size: 0.9rem; color: var(--text-secondary); line-height: 1.5; white-space: pre-line; }
        
        #user-info { font-size: 0.8rem; color: var(--text-secondary); margin-left: auto; }
        .logout-link { color: var(--danger); text-decoration: underline; cursor: pointer; margin-left: 10px; }

        /* --- RESPONSIVIDADE MOBILE --- */
        @media (max-width: 768px) {
            .flight-layout { grid-template-columns: 1fr; }
            .task-panel { margin-bottom: 20px; order: -1; position: relative; top: 0; }
            .service-layout { grid-template-columns: 1fr; }
            .service-sidebar { order: -1; margin-bottom: 20px; position: relative; top: 0; }
        }
    </style>
</head>
<body>

    <div id="login-screen">
        <div class="login-box">
            <div class="login-logo">‚úàÔ∏è</div>
            <h2>FlightOps Manager</h2>
            <p style="color:var(--text-secondary); margin-bottom:20px;">Acesso Restrito √† Equipe</p>
            
            <input type="email" id="login-email" class="form-input" placeholder="Seu e-mail corporativo">
            <input type="password" id="login-pass" class="form-input" placeholder="Sua senha">
            
            <button class="btn-action btn-primary" onclick="fazerLogin()">Entrar no Sistema</button>
            <p id="login-msg" style="color:var(--danger); margin-top:10px; font-size:0.9rem;"></p>
        </div>
    </div>

    <div id="alert-overlay">
        <div class="alert-box">
            <div class="alert-icon">‚ö†Ô∏è</div>
            <div class="alert-title">Aten√ß√£o Operacional</div>
            <div class="alert-author" id="alert-author-text"></div>
            <div class="alert-message" id="alert-msg-text"></div>
            <button class="btn-action btn-primary" onclick="fecharAlerta()">CIENTE</button>
        </div>
    </div>

    <div id="app-container" class="container hidden">
        
        <div id="view-dashboard" class="screen active">
            <header>
                <h1>‚úàÔ∏è Opera√ß√µes Solo</h1>
                <div id="user-info">Carregando...</div>
            </header>
            <div id="flight-list">Carregando voos...</div>
        </div>

        <div id="view-flight" class="screen">
            <header>
                <button class="btn-back" onclick="navTo('view-dashboard')">‚Üê</button>
                <div style="flex:1">
                    <h1 id="flight-title" style="margin-bottom:5px;">Voo</h1>
                    <select id="status-selector" class="form-select" style="width: auto; margin-bottom: 0; padding: 6px; font-size: 0.8rem; border-color: var(--border-color);" onchange="alterarStatusVoo(this.value)">
                        <option value="status-aberto">üü¢ ABERTO</option>
                        <option value="status-checkin">üü† CHECKIN FINALIZADO</option>
                        <option value="status-finalizado">üî¥ FINALIZADO</option>
                    </select>
                </div>
            </header>

            <div style="background: var(--bg-card); padding: 8px 12px; border-radius: 8px; margin-bottom: 15px; font-size: 0.85rem; display: flex; justify-content: space-between; align-items: center;">
                <span style="color: var(--text-secondary)">Sua fun√ß√£o neste voo:</span>
                <span id="current-role-display" style="font-weight: bold; color: white;">...</span>
            </div>

            <div class="flight-layout">
                
                <aside class="task-panel">
                    <div class="task-header">
                        <span>Tarefas do Voo</span>
                        <button class="btn-action btn-primary btn-sm" onclick="openTaskModal()">+ Nova</button>
                    </div>
                    <div id="task-list-container" class="task-list">
                    </div>
                </aside>

                <main>
                    <div class="tab-container">
                        <button class="tab-btn active" onclick="switchFlightTab('services')">SERVI√áOS</button>
                        <button class="tab-btn" onclick="switchFlightTab('arrival')">DESEMBARQUE</button>
                        <button class="tab-btn" onclick="switchFlightTab('comments')">MURAL</button>
                    </div>
        
                    <div id="tab-services" class="tab-content active">
                        <div id="service-list"></div>
                        <div style="text-align: center; color: var(--text-secondary); font-size: 0.9rem; margin-top: 40px;" id="empty-msg">Nenhum servi√ßo especial.</div>
                    </div>

                    <div id="tab-arrival" class="tab-content">
                        <div id="arrival-content-area"></div>
                    </div>
        
                    <div id="tab-comments" class="tab-content">
                        <div id="comments-list" style="margin-bottom: 20px;"></div>
                        <div class="input-group">
                            <input id="input-comment" class="form-input" style="margin-bottom:0;" placeholder="Digite um coment√°rio ou aviso...">
                            <button class="btn-action btn-primary" style="flex:0 0 60px;" onclick="addComment()">‚û§</button>
                        </div>
                    </div>
                </main>
            </div>
        </div>

        <div id="view-service" class="screen">
            <header>
                <button class="btn-back" onclick="navTo('view-flight')">‚Üê</button>
                <div>
                    <h1 id="service-header-type" style="color:var(--primary)">TYPE</h1>
                    <div id="service-header-detail" style="font-size: 0.9rem; color: white;">Pax</div>
                </div>
            </header>
            
            <div class="service-layout">
                <div id="checklist-container"></div>
                
                <aside class="service-sidebar">
                    <div id="status-panel" class="status-card" style="display: none;">
                        <h3 style="font-size: 0.9rem; color: var(--text-secondary); text-transform: uppercase;">Status Atual</h3>
                        <div id="status-controls" class="status-btn-group"></div>
                    </div>

                    <div>
                        <button class="btn-action" style="width:100%; background: transparent; border: 1px solid var(--primary); color: var(--primary);" onclick="toggleInfo()">‚ÑπÔ∏è Ver Regras</button>
                        <div id="service-info-box" class="info-box">
                            <div class="info-title">Regras e Procedimentos</div>
                            <div id="service-rules-content" class="info-content"></div>
                        </div>
                    </div>
                    
                    <button class="btn-action" style="width:100%; background: rgba(239,68,68,0.2); color: #f87171;" onclick="deletarServicoAtual()">Remover Servi√ßo</button>
                </aside>
            </div>

        </div>

        <button id="fab" class="fab" onclick="handleFabClick()">+</button>
        
        <div id="modal-flight" class="modal-overlay">
            <div class="modal-box">
                <h2>Novo Voo (Sa√≠da)</h2>
                <input id="new-flight-code" class="form-input" placeholder="N¬∫ Voo (Ex: LA 3255)">
                <input id="new-flight-route" class="form-input" placeholder="Rota (Ex: GRU-SSA)">
                <div style="display:flex; justify-content: flex-end; gap:10px;">
                    <button class="btn-action" onclick="closeModals()">Cancelar</button>
                    <button class="btn-action btn-primary" onclick="addFlight()">Salvar</button>
                </div>
            </div>
        </div>

        <div id="modal-arrival-flight" class="modal-overlay">
            <div class="modal-box">
                <h2>Registrar Voo Chegada</h2>
                <p style="color:var(--text-secondary); margin-bottom:15px; font-size:0.9rem;">Crie o voo de desembarque para iniciar.</p>
                <input id="arr-flight-code" class="form-input" placeholder="N¬∫ Voo Chegada (Ex: LA 3200)">
                <input id="arr-flight-route" class="form-input" placeholder="Rota (Ex: GIG-GRU)">
                <div style="display:flex; justify-content: flex-end; gap:10px;">
                    <button class="btn-action" onclick="closeModals()">Cancelar</button>
                    <button class="btn-action btn-primary" onclick="createArrivalFlight()">Criar Desembarque</button>
                </div>
            </div>
        </div>

        <div id="modal-arrival-item" class="modal-overlay">
            <div class="modal-box">
                <h2>Info de Bagagem</h2>
                
                <label style="font-size:0.9rem; color:var(--text-secondary);">Quantidade HVC:</label>
                <input id="item-hvc-qty" type="number" class="form-input" placeholder="0">
                
                <div style="background: rgba(255,255,255,0.05); padding:15px; border-radius:8px; margin-bottom:15px;">
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <span style="font-weight:bold;">Tem BAG SIG?</span>
                        <input type="checkbox" id="check-has-sig" style="width:20px; height:20px;" onchange="toggleSigFields()">
                    </div>
                    
                    <div id="sig-fields" style="display:none; margin-top:15px; padding-top:15px; border-top:1px solid var(--border-color);">
                        <p style="color:var(--sig-color); font-size:0.8rem; margin-bottom:10px; font-weight:bold;">DETALHES SIG (Alta Prioridade)</p>
                        <input id="item-sig-pax" class="form-input" placeholder="Nome do PAX">
                        <input id="item-sig-seat" class="form-input" placeholder="Assento (Opcional)">
                        <input id="item-sig-qty" type="number" class="form-input" placeholder="Qtd Bagagens SIG">
                    </div>
                </div>

                <div style="display:flex; justify-content: flex-end; gap:10px;">
                    <button class="btn-action" onclick="closeModals()">Cancelar</button>
                    <button class="btn-action btn-primary" onclick="addArrivalItem()">Adicionar Info</button>
                </div>
            </div>
        </div>

        <div id="modal-service" class="modal-overlay">
            <div class="modal-box">
                <h2>Adicionar Servi√ßo</h2>
                <select id="new-service-type" class="form-select">
                    <option value="PETC">PETC (Pet na Cabine)</option>
                    <option value="UMNR">UMNR (Menor Desacompanhado)</option>
                    <option value="AVIH">AVIH (Animal no Por√£o)</option>
                    <option value="MAAS">MAAS (Assist√™ncia)</option>
                    <optgroup label="Cadeira de Rodas / Mobilidade">
                        <option value="WCHR">WCHR (Ramp - Sobe escada)</option>
                        <option value="WCHS">WCHS (Steps - N√£o sobe escada)</option>
                        <option value="WCHC">WCHC (Cabin - Im√≥vel)</option>
                        <option value="WCMP">WCMP (Manual Power)</option>
                        <option value="WCBD">WCBD (Bateria Seca)</option>
                        <option value="WCBW">WCBW (Bateria √ömida)</option>
                        <option value="WCLB">WCLB (Bateria L√≠tio)</option>
                    </optgroup>
                </select>
                <input id="new-service-pax" class="form-input" placeholder="Nome do Passageiro">
                <input id="new-service-seat" class="form-input" placeholder="Assento (Ex: 15C)">
                <div style="display:flex; justify-content: flex-end; gap:10px;">
                    <button class="btn-action" onclick="closeModals()">Cancelar</button>
                    <button class="btn-action btn-primary" onclick="addService()">Adicionar</button>
                </div>
            </div>
        </div>

        <div id="modal-task" class="modal-overlay">
            <div class="modal-box">
                <h2>Nova Tarefa</h2>
                <input id="new-task-text" class="form-input" placeholder="Descri√ß√£o da tarefa (Ex: Pegar Lacre na Rampa)">
                <select id="new-task-priority" class="form-select">
                    <option value="normal">üîµ Rotina</option>
                    <option value="high">üî¥ URGENTE / IMPORTANTE</option>
                </select>
                <div style="display:flex; justify-content: flex-end; gap:10px;">
                    <button class="btn-action" onclick="closeModals()">Cancelar</button>
                    <button class="btn-action btn-primary" onclick="addTask()">Criar Tarefa</button>
                </div>
            </div>
        </div>

        <div id="modal-role" class="modal-overlay" style="z-index: 300;">
            <div class="modal-box">
                <h2 style="text-align: center; margin-bottom: 20px;">Quem √© voc√™ neste voo?</h2>
                <p style="color: var(--text-secondary); text-align: center; margin-bottom: 20px; font-size: 0.9rem;">Escolha sua fun√ß√£o para acessar o painel.</p>
                
                <button class="btn-action btn-role" onclick="selectRole('Check-in')">
                    <div style="font-weight: bold; color: white;">1. Check-in</div>
                    <div style="font-size: 0.8rem; color: var(--text-secondary);">Agente de Aeroporto</div>
                </button>

                <button class="btn-action btn-role" onclick="selectRole('Controller')">
                    <div style="font-weight: bold; color: #f87171;">2. Controller</div>
                    <div style="font-size: 0.8rem; color: var(--text-secondary);">Controle de Voo / Dispatch (Alertas Vermelhos)</div>
                </button>

                <button class="btn-action btn-role" onclick="selectRole('Port√£o')">
                    <div style="font-weight: bold; color: #f87171;">3. Port√£o</div>
                    <div style="font-size: 0.8rem; color: var(--text-secondary);">L√≠der de Embarque (Alertas Vermelhos)</div>
                </button>

                <button class="btn-action" style="margin-top: 10px; width: 100%;" onclick="closeModals()">Cancelar</button>
            </div>
        </div>

    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, updateDoc, deleteDoc, doc, onSnapshot, query, orderBy, getDoc } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";

        // SUA CONFIGURA√á√ÉO OFICIAL
        const firebaseConfig = {
            apiKey: "AIzaSyDUDhMZmRNx2msn9SM4Nw5nA3OSRm-hkI0",
            authDomain: "flightops-app.firebaseapp.com",
            projectId: "flightops-app",
            storageBucket: "flightops-app.firebasestorage.app",
            messagingSenderId: "670439671056",
            appId: "1:670439671056:web:5fb610571eaf4d19c9d195",
            measurementId: "G-6082JH911G"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        let currentUserEmail = "";
        
        let currentRole = ""; 
        let pendingFlightId = null;
        let currentTab = 'services'; // Controle da aba ativa

        // --- LOGIN & WHITELIST ---
        window.fazerLogin = async () => {
            const email = document.getElementById('login-email').value;
            const pass = document.getElementById('login-pass').value;
            const msg = document.getElementById('login-msg');
            
            if(!email || !pass) { msg.innerText = "Preencha tudo."; return; }
            msg.innerText = "Verificando...";

            try {
                const userCredential = await signInWithEmailAndPassword(auth, email, pass);
                const user = userCredential.user;
                const whitelistRef = doc(db, "whitelist", user.email);
                const docSnap = await getDoc(whitelistRef);

                if (docSnap.exists()) {
                    msg.innerText = "";
                } else {
                    throw new Error("Usu√°rio n√£o autorizado pelo administrador.");
                }
            } catch (error) {
                msg.innerText = "Erro: " + error.message;
                signOut(auth);
            }
        };

        window.sair = () => signOut(auth);

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                const whitelistRef = doc(db, "whitelist", user.email);
                const docSnap = await getDoc(whitelistRef);
                
                if(docSnap.exists()) {
                    currentUserEmail = user.email;
                    document.getElementById('login-screen').classList.add('hidden');
                    document.getElementById('app-container').classList.remove('hidden');
                    document.getElementById('user-info').innerHTML = `
                        ${user.email.split('@')[0]} <span class="logout-link" onclick="sair()">(Sair)</span>
                    `;
                    iniciarAppEmTempoReal();
                } else {
                    signOut(auth);
                }
            } else {
                document.getElementById('login-screen').classList.remove('hidden');
                document.getElementById('app-container').classList.add('hidden');
            }
        });


        // --- L√ìGICA DO APP ---
        
        let localFlights = [];
        let currentFlightId = null;
        let currentServiceIndex = null;
        let lastCommentCount = 0; 

        function iniciarAppEmTempoReal() {
            const q = query(collection(db, "voos"), orderBy("createdAt", "desc"));
            
            onSnapshot(q, (snapshot) => {
                localFlights = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
                renderDashboard();
                if(currentFlightId) {
                    const updatedFlight = localFlights.find(f => f.id === currentFlightId);
                    if(updatedFlight) {
                        if (document.getElementById('view-service').classList.contains('active')) {
                            updateServiceViewUI(updatedFlight);
                        }
                        renderFlightDetails(updatedFlight);
                    }
                }
            });
        }

        window.startOpenFlight = (id) => {
            pendingFlightId = id;
            document.getElementById('modal-role').style.display = 'flex';
        };

        window.selectRole = (role) => {
            currentRole = role;
            document.getElementById('modal-role').style.display = 'none';
            if(pendingFlightId) {
                window.openFlight(pendingFlightId);
            }
        };

        // --- RENDERIZA√á√ÉO ---

        const getStatusConfig = (status) => {
            switch(status) {
                case 'status-aberto': return { text: 'Aberto', class: 'aberto' };
                case 'status-checkin': return { text: 'Check-in Finalizado', class: 'checkin' };
                case 'status-finalizado': return { text: 'Finalizado', class: 'finalizado' };
                default: return { text: 'Aberto', class: 'aberto' };
            }
        };

        window.renderDashboard = () => {
            const list = document.getElementById('flight-list');
            list.innerHTML = '';
            
            localFlights.forEach(flight => {
                const config = getStatusConfig(flight.status);
                const card = document.createElement('div');
                card.className = `card ${flight.status}`;
                card.onclick = (e) => { if(!e.target.closest('button')) window.startOpenFlight(flight.id); };
                
                card.innerHTML = `
                    <div class="card-header">
                        <div><div class="flight-code">${flight.code}</div><div class="flight-route">${flight.route}</div></div>
                        <span class="badge ${config.class}">${config.text}</span>
                    </div>
                    <div class="card-actions">
                        <button class="btn-action" style="background:transparent; color:#ef4444; flex:0;" onclick="deleteFlight('${flight.id}')">üóëÔ∏è</button>
                        <button class="btn-action btn-primary" onclick="startOpenFlight('${flight.id}')">Detalhes</button>
                    </div>
                `;
                list.appendChild(card);
            });
        };

        window.navTo = (screenId) => {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(screenId).classList.add('active');
            updateFabVisibility(screenId);
        };

        function updateFabVisibility(screenId) {
            const fab = document.getElementById('fab');
            if(screenId === 'view-service') {
                fab.style.display = 'none';
            } else if (screenId === 'view-flight') {
                // L√≥gica do FAB baseada na ABA atual
                if(currentTab === 'services') {
                    fab.style.display = 'grid';
                    fab.onclick = () => { document.getElementById('modal-service').style.display = 'flex'; };
                } else if(currentTab === 'arrival') {
                    // FAB no Desembarque s√≥ aparece se o voo de chegada j√° foi criado
                    const flight = localFlights.find(f => f.id === currentFlightId);
                    if(flight && flight.arrival) {
                        fab.style.display = 'grid';
                        fab.onclick = () => { 
                            document.getElementById('check-has-sig').checked = false;
                            toggleSigFields(); // Resetar campos
                            document.getElementById('modal-arrival-item').style.display = 'flex'; 
                        };
                    } else {
                        fab.style.display = 'none'; // Se n√£o tem voo criado, usa o bot√£o grande
                    }
                } else {
                    fab.style.display = 'none'; // Mural n√£o tem FAB
                }
            } else {
                // Dashboard
                fab.style.display = 'grid';
                fab.onclick = () => { document.getElementById('modal-flight').style.display = 'flex'; };
            }
        }

        window.switchFlightTab = (tabName) => {
            currentTab = tabName;
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            
            // Ativa o bot√£o correto (√≠ndices hardcoded: 0=Services, 1=Arrival, 2=Comments)
            const btns = document.querySelectorAll('.tab-btn');
            if(tabName === 'services') btns[0].classList.add('active');
            if(tabName === 'arrival') btns[1].classList.add('active');
            if(tabName === 'comments') btns[2].classList.add('active');

            document.getElementById(`tab-${tabName}`).classList.add('active');
            updateFabVisibility('view-flight');
        };

        window.openFlight = (id) => {
            currentFlightId = id;
            const flight = localFlights.find(f => f.id === id);
            if(!flight) return;

            lastCommentCount = (flight.comments || []).length;
            document.getElementById('current-role-display').innerText = currentRole;

            window.switchFlightTab('services');
            renderFlightDetails(flight);
            navTo('view-flight');
        };

        window.renderFlightDetails = (flight) => {
            document.getElementById('flight-title').innerText = flight.code;
            document.getElementById('status-selector').value = flight.status;
            
            renderTasks(flight.tasks || []);

            const list = document.getElementById('service-list');
            const emptyMsg = document.getElementById('empty-msg');
            list.innerHTML = '';
            const services = flight.services || [];

            if (services.length === 0) {
                emptyMsg.style.display = 'block';
            } else {
                emptyMsg.style.display = 'none';
                services.forEach((service, index) => {
                    const checkedCount = Object.values(service.checks || {}).filter(Boolean).length;
                    
                    let statusPill = '';
                    if (service.stage === 'lounge') statusPill = '<span class="service-status-pill" style="background:rgba(34,197,94,0.2); color:#4ade80;">NA SALA</span>';
                    else if (service.stage === 'ramp_delivered') statusPill = '<span class="service-status-pill" style="background:rgba(34,197,94,0.2); color:#4ade80;">NA TRIAGEM</span>';
                    else if (service.stage === 'standby' && ['MAAS', 'UMNR'].includes(service.type)) statusPill = '<span class="service-status-pill" style="background:rgba(245,158,11,0.2); color:#fb923c;">STANDBY</span>';

                    const div = document.createElement('div');
                    div.className = 'service-item';
                    div.onclick = () => window.openService(index);
                    div.innerHTML = `
                        <div style="display:flex; align-items:center;">
                            <span class="service-type">${service.type}</span>
                            <div>
                                <div class="service-pax">${service.paxName} ${statusPill}</div>
                                <div class="service-seat">Assento ${service.seat}</div>
                            </div>
                        </div>
                        <div class="service-check">${checkedCount} ok</div>
                    `;
                    list.appendChild(div);
                });
            }

            // RENDER DESEMBARQUE
            renderArrivalTab(flight);

            const commentsList = document.getElementById('comments-list');
            commentsList.innerHTML = '';
            const comments = flight.comments || [];
            
            if (comments.length > lastCommentCount) {
                const latestComment = comments[comments.length - 1];
                const isPowerRole = latestComment.role === 'Controller' || latestComment.role === 'Port√£o';
                const isNotMe = latestComment.user !== currentUserEmail;

                if (isPowerRole && isNotMe) {
                    mostrarAlerta(latestComment.role, latestComment.text, latestComment.user);
                }
            }
            lastCommentCount = comments.length;

            if(comments.length === 0) {
                commentsList.innerHTML = '<p style="text-align:center; color:var(--text-secondary); margin-top:20px;">Nenhum aviso no mural.</p>';
            } else {
                comments.forEach(c => {
                    const date = new Date(c.timestamp);
                    const timeStr = `${date.getDate()}/${date.getMonth()+1} ${date.getHours()}:${date.getMinutes().toString().padStart(2,'0')}`;
                    const isUrgent = c.role === 'Controller' || c.role === 'Port√£o';
                    const urgentClass = isUrgent ? 'urgent' : '';
                    
                    const div = document.createElement('div');
                    div.className = `comment-box ${urgentClass}`;
                    div.innerHTML = `
                        <div class="comment-header">
                            <span class="comment-user">
                                ${c.user.split('@')[0]} 
                                <span class="comment-role-badge">${c.role || 'Geral'}</span>
                            </span>
                            <span class="comment-time">${timeStr}</span>
                        </div>
                        <div class="comment-text">${c.text}</div>
                    `;
                    commentsList.appendChild(div);
                });
                commentsList.scrollTop = commentsList.scrollHeight;
            }
        };

        // --- L√ìGICA DE DESEMBARQUE ---
        window.renderArrivalTab = (flight) => {
            const container = document.getElementById('arrival-content-area');
            container.innerHTML = '';

            // Se n√£o existe objeto 'arrival', mostrar bot√£o de cria√ß√£o
            if(!flight.arrival) {
                container.innerHTML = `
                    <button class="arrival-create-btn" onclick="document.getElementById('modal-arrival-flight').style.display='flex'">
                        <div style="font-size:2rem; margin-bottom:10px;">üõ¨</div>
                        <strong>Vincular Voo de Desembarque</strong>
                        <div style="font-size:0.9rem; margin-top:5px;">Clique para configurar o voo de chegada</div>
                    </button>
                `;
                return;
            }

            // Cabe√ßalho do Desembarque
            container.innerHTML = `
                <div class="arrival-header-card">
                    <h2 style="margin:0; color:white;">${flight.arrival.code}</h2>
                    <div style="color:var(--text-secondary); margin-top:5px;">Rota: ${flight.arrival.route}</div>
                </div>
            `;

            // Lista de Itens (Bagagens/Infos)
            const items = flight.arrivalItems || [];
            if(items.length === 0) {
                container.innerHTML += `<div style="text-align:center; color:var(--text-secondary); margin-top:20px;">Nenhuma informa√ß√£o de bagagem registrada.</div>`;
            } else {
                items.forEach((item, idx) => {
                    const isSig = item.hasSig;
                    let detailHtml = `<span style="color:var(--text-secondary);">HVC: <strong>${item.hvcQty || 0}</strong></span>`;
                    
                    if(isSig) {
                        detailHtml = `
                            <div><span class="sig-badge">SIG</span> <span style="font-weight:bold; color:var(--sig-color);">Pax: ${item.sigPax}</span></div>
                            <div style="font-size:0.85rem; color:var(--text-secondary); margin-top:4px;">
                                Assento: ${item.sigSeat || 'N/A'} ‚Ä¢ Qtd SIG: <strong>${item.sigQty}</strong> ‚Ä¢ HVC: ${item.hvcQty}
                            </div>
                        `;
                    } else {
                         detailHtml += ` <span style="font-size:0.8rem; margin-left:10px; opacity:0.7;">(Sem SIG)</span>`;
                    }

                    const div = document.createElement('div');
                    div.className = `arrival-item ${isSig ? 'is-sig' : ''}`;
                    div.innerHTML = `
                        <div style="flex:1;">${detailHtml}</div>
                        <button style="background:none; border:none; color:#ef4444; font-size:1.2rem; cursor:pointer;" onclick="deleteArrivalItem(${idx})">√ó</button>
                    `;
                    container.appendChild(div);
                });
            }
        };

        window.createArrivalFlight = async () => {
            const code = document.getElementById('arr-flight-code').value;
            const route = document.getElementById('arr-flight-route').value;
            if(!code) return alert("Digite o n√∫mero do voo.");

            await updateDoc(doc(db, "voos", currentFlightId), {
                arrival: { code, route },
                arrivalItems: []
            });
            closeModals();
            updateFabVisibility('view-flight'); // Atualiza para mostrar o FAB de adicionar item
        };

        window.toggleSigFields = () => {
            const isChecked = document.getElementById('check-has-sig').checked;
            document.getElementById('sig-fields').style.display = isChecked ? 'block' : 'none';
        };

        window.addArrivalItem = async () => {
            const hvcQty = document.getElementById('item-hvc-qty').value;
            const hasSig = document.getElementById('check-has-sig').checked;
            
            let itemData = {
                hvcQty: hvcQty,
                hasSig: hasSig,
                createdAt: Date.now()
            };

            if(hasSig) {
                const pax = document.getElementById('item-sig-pax').value;
                const seat = document.getElementById('item-sig-seat').value;
                const sigQty = document.getElementById('item-sig-qty').value;
                
                if(!pax) return alert("Para SIG, o nome do PAX √© obrigat√≥rio.");
                
                itemData.sigPax = pax;
                itemData.sigSeat = seat;
                itemData.sigQty = sigQty;
            }

            const flight = localFlights.find(f => f.id === currentFlightId);
            const currentItems = flight.arrivalItems || [];
            
            await updateDoc(doc(db, "voos", currentFlightId), {
                arrivalItems: [...currentItems, itemData]
            });
            
            // Limpar campos
            document.getElementById('item-hvc-qty').value = '';
            document.getElementById('item-sig-pax').value = '';
            document.getElementById('item-sig-seat').value = '';
            document.getElementById('item-sig-qty').value = '';
            document.getElementById('check-has-sig').checked = false;
            toggleSigFields();
            closeModals();
        };

        window.deleteArrivalItem = async (idx) => {
            if(!confirm("Remover esta informa√ß√£o?")) return;
            const flight = localFlights.find(f => f.id === currentFlightId);
            const items = [...flight.arrivalItems];
            items.splice(idx, 1);
            await updateDoc(doc(db, "voos", currentFlightId), { arrivalItems: items });
        };


        window.renderTasks = (tasks) => {
            const container = document.getElementById('task-list-container');
            container.innerHTML = '';
            if (tasks.length === 0) {
                container.innerHTML = '<div style="text-align: center; color: var(--text-secondary); font-size: 0.8rem; padding: 10px;">Nenhuma tarefa pendente.</div>';
                return;
            }
            const sortedTasks = [...tasks].sort((a, b) => {
                if (a.priority === 'high' && b.priority !== 'high') return -1;
                if (a.priority !== 'high' && b.priority === 'high') return 1;
                if (a.done === b.done) return 0;
                return a.done ? 1 : -1;
            });

            sortedTasks.forEach((task) => {
                const isHigh = task.priority === 'high';
                const item = document.createElement('div');
                item.className = `task-item priority-${task.priority} ${task.done ? 'done' : ''}`;
                const badge = isHigh ? `<span class="task-tag tag-urgent">‚ö†Ô∏è URGENTE</span>` : `<span class="task-tag tag-routine">Rotina</span>`;
                item.innerHTML = `
                    <div class="task-top">
                        ${badge}
                        <button style="background:none; border:none; color:#ef4444; cursor:pointer; font-size:0.8rem;" onclick="deleteTask(${task.id})">‚úï</button>
                    </div>
                    <div style="display:flex; align-items:center; gap:10px;">
                        <div class="task-check ${task.done ? 'checked' : ''}" onclick="toggleTask(${task.id})"></div>
                        <div style="font-size:0.9rem; color:white; line-height:1.4;">${task.text}</div>
                    </div>
                `;
                container.appendChild(item);
            });
        };

        // --- FUN√á√ïES DE STATUS DO SERVI√áO ---

        window.openService = (index) => {
            currentServiceIndex = index;
            const flight = localFlights.find(f => f.id === currentFlightId);
            updateServiceViewUI(flight); 
            navTo('view-service');
        };

        function updateServiceViewUI(flight) {
            if (!flight.services || !flight.services[currentServiceIndex]) {
                navTo('view-flight');
                return;
            }

            const service = flight.services[currentServiceIndex];
            const template = SERVICE_TEMPLATES[service.type] || WHEELCHAIR_TEMPLATE_BASE;

            document.getElementById('service-header-type').innerText = template.name || service.type;
            document.getElementById('service-header-detail').innerText = `${service.paxName} ‚Ä¢ ${service.seat}`;
            document.getElementById('service-rules-content').innerText = template.rules || "";
            document.getElementById('service-info-box').classList.remove('visible');

            const container = document.getElementById('checklist-container');
            container.innerHTML = '';
            let globalIdx = 0;
            template.groups.forEach(group => {
                let html = `<div class="checklist-group"><div class="group-title">${group.title}</div>`;
                group.items.forEach(itemText => {
                    const isChecked = service.checks && service.checks[globalIdx] ? 'checked' : '';
                    html += `
                        <label class="check-item">
                            <input type="checkbox" class="custom-checkbox" ${isChecked} onchange="updateCheck(${globalIdx}, this.checked)">
                            <div class="check-text">${itemText}</div>
                        </label>`;
                    globalIdx++;
                });
                html += `</div>`;
                container.innerHTML += html;
            });

            // --- RENDERIZA PAINEL DE STATUS ---
            const statusPanel = document.getElementById('status-panel');
            const statusControls = document.getElementById('status-controls');
            statusControls.innerHTML = '';
            
            const isWheelchair = ["WCHR","WCHS","WCHC","WCMP","WCBD","WCBW","WCLB"].includes(service.type);
            const isTargetService = ["MAAS", "UMNR"].includes(service.type) || isWheelchair;
            const isAVIH = service.type === "AVIH";

            if (isTargetService || isAVIH) {
                statusPanel.style.display = 'block';
                
                if (isAVIH) {
                    const isDelivered = service.stage === 'ramp_delivered';
                    statusControls.innerHTML = `
                        <button class="btn-status ${isDelivered ? 'active-delivered' : ''}" onclick="setServiceStage('ramp_delivered')">
                            ${isDelivered ? '‚úÖ' : 'üì¶'} Entregue √† Triagem
                        </button>
                    `;
                } else {
                    const isStandby = !service.stage || service.stage === 'standby'; 
                    const isLounge = service.stage === 'lounge';
                    
                    statusControls.innerHTML = `
                        <button class="btn-status ${isStandby ? 'active-standby' : ''}" onclick="setServiceStage('standby')">
                            ${isStandby ? 'üü†' : '‚ö™'} Em Standby
                        </button>
                        <button class="btn-status ${isLounge ? 'active-lounge' : ''}" onclick="setServiceStage('lounge')">
                            ${isLounge ? '‚úÖ' : 'üö™'} Na Sala de Embarque
                        </button>
                    `;
                }
            } else {
                statusPanel.style.display = 'none';
            }
        }

        window.setServiceStage = async (stage) => {
            const flight = localFlights.find(f => f.id === currentFlightId);
            const services = [...flight.services];
            const currentStage = services[currentServiceIndex].stage;

            if (services[currentServiceIndex].type === 'AVIH' && currentStage === stage) {
                services[currentServiceIndex].stage = null; 
            } else {
                services[currentServiceIndex].stage = stage;
            }

            await updateDoc(doc(db, "voos", currentFlightId), { services: services });
        };


        // --- MODAL TASKS ---
        window.openTaskModal = () => document.getElementById('modal-task').style.display = 'flex';
        window.addTask = async () => {
            const text = document.getElementById('new-task-text').value;
            const priority = document.getElementById('new-task-priority').value;
            if(!text) return;
            const flightRef = doc(db, "voos", currentFlightId);
            const flight = localFlights.find(f => f.id === currentFlightId);
            const currentTasks = flight.tasks || [];
            const newTask = { id: Date.now(), text: text, priority: priority, done: false, createdAt: Date.now() };
            await updateDoc(flightRef, { tasks: [...currentTasks, newTask] });
            document.getElementById('new-task-text').value = '';
            closeModals();
        };
        window.toggleTask = async (taskId) => {
            const flight = localFlights.find(f => f.id === currentFlightId);
            const tasks = [...(flight.tasks || [])];
            const taskIndex = tasks.findIndex(t => t.id === taskId);
            if (taskIndex > -1) {
                tasks[taskIndex].done = !tasks[taskIndex].done;
                await updateDoc(doc(db, "voos", currentFlightId), { tasks });
            }
        };
        window.deleteTask = async (taskId) => {
             if(!confirm("Excluir tarefa?")) return;
             const flight = localFlights.find(f => f.id === currentFlightId);
             const tasks = (flight.tasks || []).filter(t => t.id !== taskId);
            await updateDoc(doc(db, "voos", currentFlightId), { tasks });
        };

        // --- FUN√á√ïES GERAIS ---
        window.mostrarAlerta = (role, text, userEmail) => {
            const overlay = document.getElementById('alert-overlay');
            const authorText = document.getElementById('alert-author-text');
            const msgText = document.getElementById('alert-msg-text');
            authorText.innerHTML = `Mensagem de <strong>${role}</strong> (${userEmail.split('@')[0]})`;
            msgText.innerText = text;
            overlay.style.display = 'flex';
            if(navigator.vibrate) navigator.vibrate([200, 100, 200]);
        };
        window.fecharAlerta = () => { document.getElementById('alert-overlay').style.display = 'none'; };

        window.addComment = async () => {
            const input = document.getElementById('input-comment');
            const text = input.value.trim();
            if(!text) return;
            const flightRef = doc(db, "voos", currentFlightId);
            const flight = localFlights.find(f => f.id === currentFlightId);
            const currentComments = flight.comments || [];
            const newComment = { text: text, user: currentUserEmail, role: currentRole, timestamp: Date.now() };
            await updateDoc(flightRef, { comments: [...currentComments, newComment] });
            input.value = '';
        };

        // --- TEMPLATES COMPLETOS (TEXTO ORIGINAL) ---
        const WHEELCHAIR_TEMPLATE_BASE = {
            rules: "‚Ä¢ WCHR: Passageiro sobe escadas, mas n√£o caminha longas dist√¢ncias.",
            groups: [
                {
                    title: "1. Check-in e Identifica√ß√£o",
                    items: [
                        "<strong>Valida√ß√£o do C√≥digo:</strong> Confirmar se o c√≥digo est√° inserido corretamente na reserva e verificar informa√ß√µes no SSR CKIN2.",
                        "<strong>Cart√£o de Embarque:</strong> Permitir que o passageiro utilize o Self Check-in Digital ou Kiosk, inclusive para a impress√£o.",
                        "<strong>Etiquetagem de Bagagem:</strong> Identificar a bagagem com a etiqueta PNAE / Assist√™ncia Especial (Prioridade).",
                        "<strong>Custo do Servi√ßo:</strong> Garantir que a assist√™ncia seja prestada de forma gratuita."
                    ]
                },
                {
                    title: "2. Cadeira de Rodas Pr√≥pria (se aplic√°vel)",
                    items: [
                        "<strong>Uso at√© o Port√£o:</strong> Oferecer ao passageiro a op√ß√£o de usar sua pr√≥pria cadeira manual at√© a porta da aeronave.",
                        "<strong>Etiquetagem:</strong> Colocar a etiqueta de Gate Dispatch (Despacho no Port√£o) na cadeira pr√≥pria.",
                        "<strong>Estado do Equipamento:</strong> Caso haja dano pr√©vio na cadeira, solicitar a assinatura do Limited Release."
                    ]
                }
            ]
        };

        const SERVICE_TEMPLATES = {
            "PETC": {
                name: "Pet na Cabine",
                rules: "‚Ä¢ Esp√©cie: C√£o ou Gato (>16 semanas).\n‚Ä¢ Proibido: Menor Desacompanhado, Fileira 1, Sa√≠da de Emerg√™ncia.\n‚Ä¢ Kennel R√≠gido: 36x33x19cm | Flex√≠vel: 40x28x25cm.\n‚Ä¢ Animal deve ficar totalmente dentro do kennel durante todo o voo.",
                groups: [
                    {
                        title: "1. Triagem Inicial e Elegibilidade",
                        items: [
                            "<strong>Esp√©cie e Idade:</strong> Confirmar se √© apenas c√£o ou gato com, no m√≠nimo, 16 semanas de vida.",
                            "<strong>Restri√ß√£o de Passageiro:</strong> Garantir que o passageiro n√£o √© um Menor Desacompanhado (UMNR).",
                            "<strong>Compatibilidade:</strong> Verificar se o passageiro n√£o possui ber√ßo (BSCT), oxig√™nio (PPOC), c√£o de servi√ßo (SVAN) ou suporte emocional (ESAN), pois estes s√£o incompat√≠veis.",
                            "<strong>Limite por Cabine:</strong> Validar se n√£o excede o m√°ximo de 6 animais por voo (1 na Premium Economy e 5 na Economy)."
                        ]
                    },
                    {
                        title: "2. Documenta√ß√£o e Requisitos",
                        items: [
                            "<strong>Certificado Veterin√°rio:</strong> Validar documento original e c√≥pia, emitido h√° no m√°ximo 10 dias antes do voo (nome, idade, ra√ßa, vacinas).",
                            "<strong>Vacina Antirr√°bica (Brasil):</strong> V√°lida. Se for a primeira dose, deve ter sido aplicada h√° pelo menos 21 dias.",
                            "<strong>TIMATIC:</strong> Consultar requisitos espec√≠ficos do destino/conex√£o (ex: CDC para EUA, Aruba, Noronha)."
                        ]
                    },
                    {
                        title: "3. Inspe√ß√£o do Kennel",
                        items: [
                            "<strong>Dimens√µes M√°ximas:</strong><br>‚Ä¢ R√≠gido: 36x33x19 cm<br>‚Ä¢ Flex√≠vel: 40x28x25 cm",
                            "<strong>Conforto Animal:</strong> Confirmar que o animal consegue ficar em p√© e se mover naturalmente sem tocar no teto/paredes.",
                            "<strong>Seguran√ßa e Higiene:</strong> O kennel deve ter base imperme√°vel, ventila√ß√£o e trava que impe√ßa a sa√≠da.",
                            "<strong>Proibi√ß√£o de Rodas:</strong> Negar embarque se o kennel possuir rodas."
                        ]
                    },
                    {
                        title: "4. Procedimentos e Taxas",
                        items: [
                            "<strong>SSR PETC:</strong> Inserir/verificar dados no sistema: tipo, peso (animal+kennel), ra√ßa, idade, tipo kennel e medidas.",
                            "<strong>Check-list IATA:</strong> Preencher obrigatoriamente o Check-list PETC (digital ou impresso).",
                            "<strong>Pagamento:</strong> Confirmar se a taxa foi paga (EMD, CUV ou MSR) ou encaminhar para a loja.",
                            "<strong>Aloca√ß√£o de Assento:</strong><br>‚Ä¢ <span style='color:#ef4444'>Proibido:</span> 1¬™ fileira e sa√≠das de emerg√™ncia.<br>‚Ä¢ <span style='color:#4ade80'>Recomendado:</span> C, D, J ou H (para encaixe sob assento)."
                        ]
                    },
                    {
                        title: "5. Instru√ß√µes Finais",
                        items: [
                            "<strong>Cust√≥dia a Bordo:</strong> Informar que o animal deve permanecer totalmente dentro do kennel fechado do embarque ao desembarque.",
                            "<strong>Proibi√ß√£o de Alimenta√ß√£o:</strong> Notificar que o animal n√£o pode ser alimentado a bordo.",
                            "<strong>Briefing de Embarque:</strong> Informar ao Chefe de Cabine sobre a presen√ßa do animal."
                        ]
                    }
                ]
            },
            
            "UMNR": {
                name: "Menor Desacompanhado",
                rules: "‚Ä¢ Idade: 8 a 11 (Obrigat√≥rio) | 12 a 17 (Opcional).\n‚Ä¢ Voo: Direto para <11 anos. Conex√£o s√≥ 12-17 em voos <4h.\n‚Ä¢ Proibido: Viajar com PETC/AVIH.\n‚Ä¢ Assento: Corredor. (Economy: Pen√∫ltima/Antepen√∫ltima fileira).",
                groups: [
                    {
                        title: "1. Pr√©-atendimento & Elegibilidade",
                        items: [
                            "<strong>Verificar Idade:</strong> Obrigat√≥rio (8 a 11 anos); Opcional (12 a 17 anos).",
                            "<strong>Status da Reserva:</strong> Confirmar se o servi√ßo est√° com status HK ou KK e se foi solicitado com 48h de anteced√™ncia.",
                            "<strong>Autonomia do Menor:</strong> Confirmar se compreende seguran√ßa, locomove-se sozinho e atende necessidades b√°sicas.",
                            "<strong>Restri√ß√µes de Itiner√°rio:</strong> Validar se voo √© direto para < 11 anos (conex√µes apenas 12-17 anos em voos < 4h).",
                            "<strong>Proibi√ß√µes:</strong> Garantir que n√£o viaja com animais (PETC/AVIH) ou necessita de medicamentos administrados."
                        ]
                    },
                    {
                        title: "2. Check-in & Documenta√ß√£o",
                        items: [
                            "<strong>Presen√ßa do Respons√°vel:</strong> O menor deve estar obrigatoriamente com um adulto.",
                            "<strong>Documenta√ß√£o:</strong> Conferir RG, Certid√£o de Nascimento ou Passaporte.",
                            "<strong>Autoriza√ß√£o de Viagem:</strong> Judicial, consular ou cart√≥rio. Se AEV, validar QR Code no app.",
                            "<strong>Formul√°rio UMNR:</strong> Preencher todas as vias (Original: Pai | C√≥pias: Origem, Chefe Cabine, Destino).",
                            "<strong>Pagamento:</strong> Verificar se a taxa foi paga ou encaminhar √† loja.",
                            "<strong>Etiquetagem:</strong> Colocar etiquetas 'Menor Desacompanhado' na bagagem de m√£o e despachada.",
                            "<strong>Protocolo Verbal:</strong> Informar ao respons√°vel que deve permanecer at√© a decolagem."
                        ]
                    },
                    {
                        title: "3. Cust√≥dia & Embarque",
                        items: [
                            "<strong>Child Tracker:</strong> Colocar pulseira e ler c√≥digo 2D no app (se aplic√°vel).",
                            "<strong>Envelope UM:</strong> Guardar todos os documentos e via do formul√°rio no envelope.",
                            "<strong>Acompanhamento:</strong> Agente assume o menor (max 3 menores por agente).",
                            "<strong>Prioridade:</strong> Embarcar o menor antes dos demais.",
                            "<strong>Assento Correto:</strong><br>‚Ä¢ Economy: Corredor na pen√∫ltima ou antepen√∫ltima (proibido emerg√™ncia).<br>‚Ä¢ Business: Corredor, preferencialmente 3 primeiras."
                        ]
                    }
                ]
            },

            "AVIH": {
                name: "Animal no Por√£o",
                rules: "‚Ä¢ Restri√ß√£o Calor (BR): 10h01 √†s 15h59.\n‚Ä¢ Kennel: R√≠gido, porta met√°lica trava dupla, sem rodas.\n‚Ä¢ Obrigat√≥rio: 2 potes na porta, lacres, 5cm folga teto.\n‚Ä¢ Documentos: 2 c√≥pias atestado (<10 dias).",
                groups: [
                    {
                        title: "1. Triagem Inicial e Elegibilidade",
                        items: [
                            "<strong>Reserva Confirmada:</strong> Verificar status HK/KK (min 48h anteced√™ncia).",
                            "<strong>Esp√©cie e Idade:</strong> C√£o ou gato, min 16 semanas.",
                            "<strong>Ra√ßas Proibidas:</strong> N√£o pode ser braquicef√°lico ou perigoso.",
                            "<strong>Restri√ß√µes Clim√°ticas:</strong><br>‚Ä¢ Brasil: Restrito 10h01-15h59 (Calor).<br>‚Ä¢ Intl: Verificar embargos (ex: JFK/BOS Inverno).",
                            "<strong>UMNR:</strong> Passageiro N√ÉO pode ser menor desacompanhado."
                        ]
                    },
                    {
                        title: "2. Documenta√ß√£o e Requisitos",
                        items: [
                            "<strong>Certificado Veterin√°rio:</strong> 2 c√≥pias (1 para arquivo), emitido <10 dias.",
                            "<strong>Vacina Antirr√°bica:</strong> V√°lida (>21 dias se 1¬™ dose).",
                            "<strong>TIMATIC:</strong> Consultar regras do destino (ex: CDC EUA)."
                        ]
                    },
                    {
                        title: "3. Inspe√ß√£o do Kennel",
                        items: [
                            "<strong>Material:</strong> Pl√°stico duro/fibra, porta met√°lica com trava dupla.",
                            "<strong>Caracter√≠sticas:</strong> Teto s√≥lido, base imperme√°vel, al√ßas.",
                            "<strong>Rodas:</strong> Proibido (devem ser removidas).",
                            "<strong>Acess√≥rios:</strong> 2 recipientes fixados √† porta (acesso externo).",
                            "<strong>Itens Proibidos:</strong> Sem coleiras, roupas ou brinquedos dentro."
                        ]
                    },
                    {
                        title: "4. Conforto e Seguran√ßa",
                        items: [
                            "<strong>Espa√ßo Interno:</strong> Animal fica em p√©, gira e deita naturalmente.",
                            "<strong>Folga do Teto:</strong> Min 5cm entre cabe√ßa/orelhas e o teto.",
                            "<strong>Lacres:</strong> Instalar 2 a 6 lacres na porta."
                        ]
                    },
                    {
                        title: "5. Sistema e Identifica√ß√£o",
                        items: [
                            "<strong>Pesagem:</strong> Total (Animal+Kennel) < 32kg ou 45kg.",
                            "<strong>Registro:</strong> Inserir peso e qtd exatos no sistema.",
                            "<strong>Etiquetas:</strong> 'Live Animal' preenchida + Setas 'This Way Up'.",
                            "<strong>Pet Tracker (BR):</strong> Pulseira branca no kennel + Check-in App Siga Mobile."
                        ]
                    },
                    {
                        title: "6. Finaliza√ß√£o e Rampa",
                        items: [
                            "<strong>NOTOC:</strong> Preparar notifica√ß√£o ao comandante.",
                            "<strong>Documenta√ß√£o:</strong> Anexar envelope (NOTOC + Originais) ao kennel.",
                            "<strong>Handover:</strong> Entregar √† rampa para transporte seguro."
                        ]
                    }
                ]
            },

            "MAAS": {
                name: "Assist√™ncia Especial (MAAS)",
                rules: "‚Ä¢ P√∫blico: Idosos (‚â•60), Gestantes, M√£e+Beb√™, Autonomia Limitada.\n‚Ä¢ Assentos gratuitos (Seat Selection/Atributos).\n‚Ä¢ N√ÉO √© cust√≥dia integral (√© apenas facilita√ß√£o).\n‚Ä¢ N√£o requer reserva pr√©via.",
                groups: [
                    {
                        title: "1. Triagem e Elegibilidade",
                        items: [
                            "<strong>Verificar P√∫blico-alvo:</strong> Idoso (‚â• 60 anos), gestante, m√£e com beb√™ de colo ou autonomia limitada (ex: muletas).",
                            "<strong>Sele√ß√£o de Assento:</strong> Garantir acesso gratuito aos produtos Seat Selection e Assentos com Atributos.",
                            "<strong>Esclarecimento sobre Cust√≥dia:</strong> Informar que a assist√™ncia facilita os processos, mas n√£o √© cust√≥dia integral."
                        ]
                    },
                    {
                        title: "2. Processo de Check-in",
                        items: [
                            "<strong>Ativa√ß√£o no Sistema:</strong> Identificar c√≥digo MAAS na reserva ou inserir manualmente (n√£o requer reserva pr√©via).",
                            "<strong>Etiquetagem:</strong> Identificar obrigatoriamente a bagagem com a etiqueta PNAE / Assist√™ncia Especial.",
                            "<strong>Acompanhamento Inicial:</strong> Conduzir desde o balc√£o, passando obrigatoriamente pelo Raio-X e fronteira."
                        ]
                    },
                    {
                        title: "3. Embarque e Perman√™ncia",
                        items: [
                            "<strong>Acesso Priorit√°rio:</strong> Encaminhar o passageiro atrav√©s do acesso 'Prioridade por Lei'.",
                            "<strong>Condu√ß√£o √† Aeronave:</strong> Acompanhar o passageiro at√© a porta da aeronave."
                        ]
                    }
                ]
            },

            "WCHS": {
                name: "Cadeira de Rodas (WCHS)",
                rules: "‚Ä¢ WCHS: Passageiro N√ÉO sobe escadas, mas caminha at√© o assento.\n‚Ä¢ Cadeira Pr√≥pria: Manual (Gate Dispatch) ou Motorizada (NOTOC + Bateria).\n‚Ä¢ Assento: Proibido Sa√≠da de Emerg√™ncia.\n‚Ä¢ Prioridade: Primeira fileira (Regra Brasil).",
                groups: [
                    {
                        title: "1. Recep√ß√£o e Check-in",
                        items: [
                             "<strong>Valida√ß√£o do SSR:</strong> Garantir que o c√≥digo WCHS esteja inserido. Se tiver cadeira pr√≥pria, combinar com WCMP (manual) ou WCBW/WCBD (bateria).",
                             "<strong>Emiss√£o de Cart√£o:</strong> Autorizado a emitir via Web, App ou Kiosk.",
                             "<strong>Identifica√ß√£o de Bagagem:</strong> Colocar etiqueta PNAE / Assist√™ncia Especial em todos os volumes (Prioridade).",
                             "<strong>Cadeira Pr√≥pria (Manual):</strong> Oferecer uso at√© a porta do avi√£o e colocar etiqueta de Port√£o (Gate Dispatch).",
                             "<strong>Cadeira Pr√≥pria (Motorizada):</strong> Preencher obrigatoriamente o NOTOC e coordenar a desconex√£o da bateria."
                        ]
                    },
                    {
                        title: "2. Aloca√ß√£o de Assentos",
                        items: [
                            "<strong>Seguran√ßa:</strong> <span style='color:#ef4444'>Proibir</span> terminantemente a acomoda√ß√£o em sa√≠das de emerg√™ncia.",
                            "<strong>Localiza√ß√£o:</strong> Priorizar assento no corredor e pr√≥ximo √†s portas de sa√≠da.",
                            "<strong>Regra Brasil:</strong> Acomodar preferencialmente na primeira fileira.",
                            "<strong>Benef√≠cio:</strong> Garantir isen√ß√£o de custo em produtos de sele√ß√£o de assento."
                        ]
                    }
                ]
            },

            "WCHC": {
                name: "Cadeira de Rodas (WCHC)",
                rules: "‚Ä¢ Im√≥vel: Necessita aux√≠lio integral (assento <-> aeronave).\n‚Ä¢ Acompanhante: N√£o obrigat√≥rio se tiver autonomia de evacua√ß√£o.\n‚Ä¢ Cadeira Pr√≥pria: Gate Dispatch (Manual) ou NOTOC (Motorizada).\n‚Ä¢ Assento: Proibido Sa√≠da de Emerg√™ncia. Prefer√™ncia 1¬™ Fileira.",
                groups: [
                    {
                        title: "1. Triagem e Autonomia",
                        items: [
                            "<strong>Identificar Necessidade:</strong> Confirmar que o passageiro necessita de cadeira para movimenta√ß√£o e aux√≠lio para subir/descer escadas.",
                            "<strong>Avaliar Acompanhante:</strong> O fato de n√£o caminhar n√£o obriga o uso de acompanhante, exceto se a imobilidade impedir deslocamento independente na evacua√ß√£o.",
                            "<strong>Custos:</strong> Garantir que o servi√ßo de assist√™ncia e o transporte de dispositivos de mobilidade sejam gratuitos."
                        ]
                    },
                    {
                        title: "2. Check-in e Identifica√ß√£o",
                        items: [
                            "<strong>Emiss√£o de Cart√£o:</strong> WCHC pode emitir via Web, App ou Kiosk (Brasil); Internacional pode haver restri√ß√£o.",
                            "<strong>C√≥digos no Sistema:</strong> Garantir WCHC. Se tiver cadeira pr√≥pria, combinar com c√≥digo t√©cnico (WCMP, WCBW, WCBD, WCLB).",
                            "<strong>Etiquetagem de Bagagem:</strong> Identificar todas as malas com a etiqueta PNAE / Assist√™ncia Especial (Prioridade).",
                            "<strong>Cadeira Pr√≥pria (Manual):</strong> Oferecer uso at√© a porta, aplicando etiqueta Gate Dispatch.",
                            "<strong>Cadeira Pr√≥pria (Motorizada):</strong> Preencher NOTOC, inserir peso (padr√£o 50kg) e avisar Rampa/Supervisor.",
                            "<strong>Baterias:</strong> Coordenar a desconex√£o dos terminais da bateria."
                        ]
                    },
                    {
                        title: "3. Aloca√ß√£o de Assento",
                        items: [
                            "<strong>Proibi√ß√£o:</strong> Garantir que o passageiro <span style='color:#ef4444'>n√£o seja alocado</span> em sa√≠das de emerg√™ncia.",
                            "<strong>Localiza√ß√£o:</strong> Priorizar assento no corredor e pr√≥ximo √†s portas de sa√≠da.",
                            "<strong>Regra Brasil:</strong> Acomodar preferencialmente na primeira fileira.",
                            "<strong>Benef√≠cio:</strong> Garantir acesso gratuito √† sele√ß√£o de assentos e assentos com atributos."
                        ]
                    }
                ]
            },

            "WCMP": {
                name: "Cadeira Manual Pr√≥pria (WCMP)",
                rules: "‚Ä¢ C√≥digo T√©cnico: Deve estar associado a WCHR, S ou C.\n‚Ä¢ Peso Padr√£o: 15kg (se n√£o houver peso real).\n‚Ä¢ Avarias: Preencher Limited Release se houver dano pr√©vio.\n‚Ä¢ Rodas: N√£o √© necess√°rio desinflar.",
                groups: [
                    {
                        title: "1. Check-in e Identifica√ß√£o do Equipamento",
                        items: [
                            "<strong>Emiss√£o de Bilhete:</strong> O passageiro WCMP pode emitir seu cart√£o de embarque via Web, App ou Kiosk.",
                            "<strong>Combina√ß√£o de C√≥digos:</strong> Garantir que o c√≥digo WCMP esteja associado a um c√≥digo de mobilidade (WCHR, WCHS ou WCHC).",
                            "<strong>Peso no Sistema:</strong> Inserir peso real ou, se n√£o for poss√≠vel, utilizar padr√£o de 15 kg.",
                            "<strong>Uso das Rodas:</strong> Informar que as rodas podem embarcar normalmente (sem desinflar).",
                            "<strong>Etiquetagem:</strong> Identificar cadeira com Gate Dispatch e demais bagagens com PNAE / Assist√™ncia Especial."
                        ]
                    },
                    {
                        title: "2. Verifica√ß√£o de Avarias",
                        items: [
                            "<strong>Inspe√ß√£o Pr√©via:</strong> Verificar se a cadeira j√° possui danos ou avarias.",
                            "<strong>Termo de Responsabilidade:</strong> Caso haja danos pr√©vios, solicitar <span style='color:#ef4444'>obrigatoriamente</span> a assinatura do documento Limited Release."
                        ]
                    },
                    {
                        title: "3. Aloca√ß√£o de Assento",
                        items: [
                            "<strong>Seguran√ßa:</strong> Garantir que o passageiro n√£o esteja em sa√≠das de emerg√™ncia.",
                            "<strong>Localiza√ß√£o:</strong> Priorizar assento no corredor e pr√≥ximo √†s portas de sa√≠da.",
                            "<strong>Regra Brasil:</strong> Acomodar preferencialmente na primeira fileira.",
                            "<strong>Benef√≠cio:</strong> Garantir acesso gratuito aos produtos de sele√ß√£o de assento."
                        ]
                    },
                    {
                        title: "4. Embarque e Fluxo no Port√£o",
                        items: [
                            "<strong>Op√ß√£o de Uso:</strong> Oferecer ao passageiro a alternativa de utilizar sua pr√≥pria cadeira manual at√© a porta da aeronave.",
                            "<strong>Prioridade:</strong> Realizar o embarque atrav√©s do acesso exclusivo para necessidades especiais."
                        ]
                    }
                ]
            },

            "WCBD": {
                name: "Cadeira c/ Bateria Seca (WCBD)",
                rules: "‚Ä¢ Anteced√™ncia: +1 hora extra no check-in.\n‚Ä¢ Bateria: Seca ou Gel (Selada). N√£o Derram√°vel.\n‚Ä¢ Transporte: Vertical. Bateria permanece fixada.\n‚Ä¢ NOTOC: Obrigat√≥rio (Artigo Perigoso).",
                groups: [
                    {
                        title: "1. Triagem e Apresenta√ß√£o",
                        items: [
                            "<strong>Tempo de Anteced√™ncia:</strong> Garantir que o passageiro se apresentou com 1 hora de anteced√™ncia adicional ao tempo regular (2h dom√©stico / 3h internacional).",
                            "<strong>Tipo de Bateria:</strong> Confirmar que a bateria √© seca ou de gel (selada/n√£o derram√°vel)."
                        ]
                    },
                    {
                        title: "2. Check-in e Identifica√ß√£o",
                        items: [
                            "<strong>Emiss√£o de Cart√£o:</strong> No Brasil pode usar Kiosk/App. Internacional: Apenas balc√£o.",
                            "<strong>SSR no Sistema:</strong> Validar a combina√ß√£o do c√≥digo WCBD com o n√≠vel de assist√™ncia (WCHR/S/C).",
                            "<strong>Peso do Equipamento:</strong> Inserir o peso real. Se n√£o for poss√≠vel pesar, utilizar padr√£o de 50 kg.",
                            "<strong>Coment√°rio (CM):</strong> Inserir: ‚ÄúPSGR COM PESO DE MOBILIDADE REDUZIDO OK NO SISTEMA, BT [n¬∫ da etiqueta]‚Äù.",
                            "<strong>Etiquetagem:</strong> PNAE/Assist√™ncia Especial em tudo. Se usar at√© a porta, colocar Gate Dispatch."
                        ]
                    },
                    {
                        title: "3. Procedimentos de Seguran√ßa e NOTOC",
                        items: [
                            "<strong>Preenchimento de NOTOC:</strong> Preencher obrigatoriamente o formul√°rio NOTOC para artigos perigosos.",
                            "<strong>Comunica√ß√£o Interna:</strong> Avisar o Supervisor, a equipe de rampa (EOP/COT) e a Central DOV sobre o transporte."
                        ]
                    },
                    {
                        title: "4. Prepara√ß√£o T√©cnica da Cadeira",
                        items: [
                            "<strong>Desconex√£o e Isolamento:</strong> Desconectar os terminais da bateria e isol√°-los para evitar curto-circuito (Equipe LATAM ou Pax).",
                            "<strong>Acomoda√ß√£o:</strong> A bateria seca/gel deve permanecer fixada √† cadeira e transportada na vertical.",
                            "<strong>Avarias:</strong> Se houver dano pr√©vio, solicitar assinatura do Limited Release."
                        ]
                    },
                    {
                        title: "5. Aloca√ß√£o e Embarque",
                        items: [
                            "<strong>Assento:</strong> Proibir sa√≠das de emerg√™ncia. Brasil: Priorizar 1¬™ fileira. Outros: Corredor pr√≥ximo √†s portas.",
                            "<strong>Manejo de Carga:</strong> Carregamento via Ambulift ou catering. <span style='color:#ef4444'>Proibido</span> escadas de servi√ßo.",
                            "<strong>Prioridade:</strong> Pr√©-embarque pelo acesso de necessidades especiais."
                        ]
                    }
                ]
            },

            "WCBW": {
                name: "Cadeira c/ Bateria √ömida (WCBW)",
                rules: "‚Ä¢ Anteced√™ncia: +1 hora extra no check-in.\n‚Ä¢ Bateria: Derram√°vel / L√≠quida.\n‚Ä¢ Transporte: OBRIGATORIAMENTE Vertical.\n‚Ä¢ Bateria: NUNCA deve ser removida da cadeira.",
                groups: [
                    {
                        title: "1. Triagem e Apresenta√ß√£o",
                        items: [
                            "<strong>Anteced√™ncia Adicional:</strong> Garantir 1h extra check-in (2h dom√©stico / 3h internacional).",
                            "<strong>Confirma√ß√£o da Bateria:</strong> Validar que √© derram√°vel/l√≠quida.",
                            "<strong>Inspe√ß√£o de Integridade:</strong> Verificar vazamentos. Se houver vazamento, o transporte <span style='color:#ef4444'>n√£o poder√° ser realizado</span>."
                        ]
                    },
                    {
                        title: "2. Check-in e Registros em Sistema",
                        items: [
                            "<strong>Cart√£o de Embarque:</strong> Brasil: Kiosk/App. Outros: Balc√£o.",
                            "<strong>C√≥digos de SSR:</strong> Validar c√≥digo WCBW combinado com assist√™ncia (WCHR/S/C).",
                            "<strong>Peso e Coment√°rio:</strong> Peso real (ou 50kg padr√£o). Inserir CM: ‚ÄúPSGR COM PESO DE MOBILIDADE REDUZIDO OK NO SISTEMA, BT [n¬∫ da etiqueta]‚Äù.",
                            "<strong>Etiquetagem:</strong> PNAE em tudo. Gate Dispatch se for at√© a porta."
                        ]
                    },
                    {
                        title: "3. Prepara√ß√£o T√©cnica (Bateria Derram√°vel)",
                        items: [
                            "<strong>Desconex√£o e Isolamento:</strong> Desconectar cabos e isolar terminais (Pax ou Equipe LATAM).",
                            "<strong>N√£o Remo√ß√£o:</strong> A bateria derram√°vel <span style='color:#ef4444'>nunca</span> deve ser removida da cadeira.",
                            "<strong>Posi√ß√£o Vertical:</strong> Garantir que a cadeira permane√ßa na posi√ß√£o vertical em todas as etapas.",
                            "<strong>Ferramentas:</strong> Se usar ferramentas da LATAM, despach√°-las na bagagem ap√≥s o uso."
                        ]
                    },
                    {
                        title: "4. Seguran√ßa e Embarque",
                        items: [
                            "<strong>NOTOC:</strong> Preencher obrigatoriamente e entregar ao Comandante/Rampa.",
                            "<strong>Manejo de Carga:</strong> Carregamento via Ambulift/Catering. Proibido escadas de servi√ßo.",
                            "<strong>Assento:</strong> Proibido sa√≠da de emerg√™ncia. Priorizar 1¬™ fileira (Brasil).",
                            "<strong>Avarias:</strong> Solicitar Limited Release se houver dano pr√©vio."
                        ]
                    }
                ]
            },

            "WCLB": {
                name: "Cadeira c/ Bateria L√≠tio (WCLB)",
                rules: "‚Ä¢ Anteced√™ncia: +1 hora extra no check-in.\n‚Ä¢ Instalada: Sem limite Wh.\n‚Ä¢ Removida (Cabine): Max 1x300Wh ou 2x160Wh.\n‚Ä¢ C√°lculo: Voltagem (V) x Ampere-hora (Ah).",
                groups: [
                    {
                        title: "1. Triagem e Apresenta√ß√£o",
                        items: [
                            "<strong>Anteced√™ncia:</strong> Validar 1h extra check-in (2h dom√©stico / 3h internacional).",
                            "<strong>Emiss√£o de Cart√£o:</strong> Brasil: Kiosk/App/Web. Outros: Balc√£o."
                        ]
                    },
                    {
                        title: "2. An√°lise T√©cnica da Bateria (L√≠tio)",
                        items: [
                            "<strong>Removibilidade:</strong> Verificar se a bateria pode ou n√£o ser removida.",
                            "<strong>Baterias Instaladas (Fixas):</strong> N√£o h√° limite de Wh.",
                            "<strong>Baterias Remov√≠veis (Cabine):</strong> Se removida, n√£o pode exceder: 1 bateria at√© 300 Wh OU 2 baterias at√© 160 Wh cada.",
                            "<strong>C√°lculo de Pot√™ncia:</strong> Se n√£o houver Wh na etiqueta, calcular: Voltagem (V) x Ampere-hora (Ah)."
                        ]
                    },
                    {
                        title: "3. Check-in e Registros em Sistema",
                        items: [
                            "<strong>Peso e Coment√°rio:</strong> Peso real (ou 50kg padr√£o). Inserir CM: ‚ÄúPSGR COM PESO DE MOBILIDADE REDUZIDO OK NO SISTEMA, BT [n¬∫ da etiqueta]‚Äù.",
                            "<strong>Etiquetagem:</strong> PNAE em tudo. Gate Dispatch se for at√© a porta.",
                            "<strong>Avarias:</strong> Solicitar Limited Release se houver dano pr√©vio."
                        ]
                    },
                    {
                        title: "4. Procedimentos de Seguran√ßa e NOTOC",
                        items: [
                            "<strong>NOTOC:</strong> Preencher obrigatoriamente (especificar tipo e se foi removida).",
                            "<strong>Comunica√ß√£o:</strong> Avisar Supervisor, Rampa e DOV.",
                            "<strong>Prepara√ß√£o:</strong> Terminais desconectados e isolados. Se removida, bateria vai na cabine com o Pax."
                        ]
                    },
                    {
                        title: "5. Embarque e Manejo",
                        items: [
                            "<strong>Aloca√ß√£o:</strong> Proibir sa√≠da de emerg√™ncia. Priorizar 1¬™ fileira (Brasil).",
                            "<strong>Posicionamento:</strong> Transporte sempre na vertical.",
                            "<strong>Manejo de Carga:</strong> Carregamento via Ambulift/Catering. Proibido escadas de servi√ßo."
                        ]
                    }
                ]
            }
        };

        const wheelchairCodes = ["WCHR"];
        wheelchairCodes.forEach(code => {
            SERVICE_TEMPLATES[code] = {
                ...WHEELCHAIR_TEMPLATE_BASE,
                name: `Cadeira de Rodas (${code})`
            };
        });

        // --- A√á√ïES DB ---
        window.alterarStatusVoo = async (novoStatus) => {
            if(!currentFlightId) return;
            await updateDoc(doc(db, "voos", currentFlightId), { status: novoStatus });
        };
        window.addFlight = async () => {
            const code = document.getElementById('new-flight-code').value;
            const route = document.getElementById('new-flight-route').value;
            if(!code) return;
            await addDoc(collection(db, "voos"), { code, route, status: "status-aberto", services: [], comments: [], tasks: [], createdAt: Date.now() });
            closeModals();
            document.getElementById('new-flight-code').value = ''; document.getElementById('new-flight-route').value = '';
        };
        window.deleteFlight = async (id) => { if(confirm("Apagar voo?")) await deleteDoc(doc(db, "voos", id)); };
        window.addService = async () => {
            const type = document.getElementById('new-service-type').value;
            const pax = document.getElementById('new-service-pax').value;
            const seat = document.getElementById('new-service-seat').value;
            if(!pax) return;
            const flight = localFlights.find(f => f.id === currentFlightId);
            const newServices = [...flight.services, { type, paxName: pax, seat: seat || "S/A", checks: {} }];
            await updateDoc(doc(db, "voos", currentFlightId), { services: newServices });
            closeModals(); document.getElementById('new-service-pax').value = '';
        };
        window.updateCheck = async (idx, checked) => {
            const flight = localFlights.find(f => f.id === currentFlightId);
            const services = [...flight.services];
            if(!services[currentServiceIndex].checks) services[currentServiceIndex].checks = {};
            services[currentServiceIndex].checks[idx] = checked;
            await updateDoc(doc(db, "voos", currentFlightId), { services: services });
        };
        window.deletarServicoAtual = async () => {
            if(confirm("Remover servi√ßo?")) {
                const flight = localFlights.find(f => f.id === currentFlightId);
                const services = [...flight.services];
                services.splice(currentServiceIndex, 1);
                await updateDoc(doc(db, "voos", currentFlightId), { services: services });
                navTo('view-flight');
            }
        };

        window.handleFabClick = () => {
            if(document.getElementById('view-dashboard').classList.contains('active')) {
                document.getElementById('modal-flight').style.display = 'flex';
            } else if (currentTab === 'arrival') {
                document.getElementById('modal-arrival-item').style.display = 'flex';
            } else {
                document.getElementById('modal-service').style.display = 'flex';
            }
        };
        window.closeModals = () => document.querySelectorAll('.modal-overlay').forEach(m => m.style.display = 'none');
        window.toggleInfo = () => document.getElementById('service-info-box').classList.toggle('visible');

    </script>
</body>
</html>